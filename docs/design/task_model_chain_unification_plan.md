# TaskModel é“¾è·¯ç»Ÿä¸€æ”¹é€ æ–¹æ¡ˆï¼ˆç»“åˆ ModuleProcessorWithChainï¼‰

## 1. èƒŒæ™¯ä¸ç›®æ ‡

å½“å‰ç³»ç»Ÿä¸­ï¼ŒTaskModel / ParserTaskModel / ErrorTaskModel åˆ†åˆ«é€šè¿‡å¤šæ¡ç›¸ä¼¼é“¾è·¯å¤„ç†ï¼Œå­˜åœ¨å¦‚ä¸‹é—®é¢˜ï¼š

1. é€»è¾‘é‡å¤ï¼š`create_task_model_chain`ã€`create_parser_task_chain`ã€`create_error_task_chain` ç»“æ„é«˜åº¦é‡å¤ï¼Œæ¼”è¿›æ—¶å®¹æ˜“å‡ºç°è¡Œä¸ºä¸ä¸€è‡´ã€‚
2. å¤±è´¥è¯­ä¹‰åˆ†æ•£ï¼šä¸åŒé“¾è·¯å¯¹é”™è¯¯ã€é‡è¯•ã€è·³è¿‡çš„å¤„ç†ç­–ç•¥ä¸ç»Ÿä¸€ï¼Œå®¹æ˜“å¯¼è‡´â€œé™é»˜ä¸¢ä»»åŠ¡â€ã€‚
3. æ¨¡å—å†…é“¾å¼çŠ¶æ€ä¸å¤–å±‚é“¾è·¯è€¦åˆä¸æ¸…ï¼š`ModuleProcessorWithChain` å·²å…·å¤‡ step æ¨è¿›ã€å›é€€é—¨é—¸ã€åœæ­¢ä¿¡å·ç­‰èƒ½åŠ›ï¼Œä½†å¤–å±‚é“¾è·¯æ²¡æœ‰å……åˆ†åˆ©ç”¨å…¶é—­ç¯èƒ½åŠ›ã€‚
4. é˜ˆå€¼åˆ¤å®šæ—¶æœºä¸ç»Ÿä¸€ï¼šæ¨¡å—çº§å’Œä»»åŠ¡çº§é”™è¯¯é˜ˆå€¼åœ¨ä¸åŒè·¯å¾„é‡å¤åˆ¤æ–­ï¼Œå¯èƒ½å‡ºç°è®¡æ•°å’Œå†³ç­–åˆ†è£‚ã€‚

æœ¬æ¬¡æ”¹é€ ç›®æ ‡ï¼š

- ç»Ÿä¸€å…¥å£ä¸è°ƒåº¦ï¼šä¸‰ç±»ä»»åŠ¡æ¶ˆæ¯èµ°ç»Ÿä¸€å¤„ç†å…¥å£ã€‚
- ç»Ÿä¸€æ¨¡å—æ‰§è¡Œé—­ç¯ï¼šæ¨¡å—å†…â€œç”Ÿæˆ -> ä¸‹è½½ -> è§£æ -> åˆ¤å®š -> æ¨è¿›/ç»ˆæ­¢/å›æµâ€ç”± `ModuleProcessorWithChain` é©±åŠ¨ã€‚
- ç»Ÿä¸€é”™è¯¯æ²»ç†ï¼šè§£æå¤±è´¥è‡ªåŠ¨äº§å‡º ErrorTaskModelï¼Œè¿›å…¥é”™è¯¯é˜Ÿåˆ—åæ‰§è¡Œâ€œæ¨¡å—çº§ + ä»»åŠ¡çº§â€åŒé˜ˆå€¼åˆ¤å®šã€‚
- ç»Ÿä¸€è¯­ä¹‰ï¼šæ˜ç¡®æ¯ä¸ªé˜¶æ®µ Success / Retry / Stop / Drop çš„è¡Œä¸ºï¼Œå¹¶ä¿è¯å¯è§‚æµ‹ã€‚

---

## 2. èŒƒå›´ä¸éç›®æ ‡

### 2.1 èŒƒå›´

- é‡æ„ä»»åŠ¡å…¥å£ç¼–æ’ï¼ˆTaskModel/ParserTaskModel/ErrorTaskModelï¼‰ã€‚
- æ˜ç¡®ä¸ `ModuleProcessorWithChain` çš„èŒè´£è¾¹ç•Œä¸äº¤äº’åè®®ã€‚
- ç»Ÿä¸€é”™è¯¯é˜ˆå€¼åˆ¤å®šæµç¨‹ä¸æ•°æ®å¥‘çº¦ã€‚
- ç»™å‡ºè¿ç§»æ­¥éª¤ã€éªŒè¯ç­–ç•¥ã€å›æ»šæ–¹æ¡ˆã€‚

### 2.2 éç›®æ ‡

- ä¸æ”¹å˜æ•°æ®åº“è¡¨ç»“æ„ã€‚
- ä¸æ”¹å˜ä¸‹è½½å™¨ã€è§£æå™¨å…·ä½“ä¸šåŠ¡é€»è¾‘ã€‚
- ä¸å¼•å…¥æ–°çš„å¤–éƒ¨ä¸­é—´ä»¶ç³»ç»Ÿã€‚

### 2.3 å½“å‰æ‰§è¡Œè¾¹ç•Œï¼ˆèŒƒå›´æ”¶æ•›ï¼‰

> æœ¬è½®ä»…èšç„¦ **TaskModel é“¾è·¯æ”¹é€ ä¸»çº¿**ï¼Œå³ T04~T07 + T09 æ”¶å£ï¼›
> T10~T12 çš„è§‚æµ‹æ€§/ç°åº¦/å›æ»šå†…å®¹ä»…ä¿ç•™æ–‡æ¡£èµ„äº§ï¼Œä¸ä½œä¸ºå½“å‰å®ç°ä¸»çº¿ã€‚

- ä¸»çº¿ä¼˜å…ˆï¼šç»Ÿä¸€å…¥å£ç¼–æ’ã€ModuleProcessorWithChain èŒè´£æ”¶æ•›ã€Parser/Error é—­ç¯ã€é”®è§„èŒƒã€Lua åŸå­è¯­ä¹‰ã€‚
- æš‚ç¼“é¡¹ï¼šå‘Šè­¦é˜ˆå€¼æ ¡å‡†ã€ç°åº¦æ¼”ç»ƒã€ä¸Šçº¿æ²»ç†æ¨¡æ¿çš„è¿›ä¸€æ­¥æ‰©å±•ã€‚

---

## 3. ç»Ÿä¸€åçš„æ€»ä½“æ¶æ„

é‡‡ç”¨â€œä¸¤å±‚é“¾è·¯â€æ¨¡å‹ï¼š

1. **Task Ingress Chainï¼ˆä»»åŠ¡å…¥å£é“¾ï¼‰**
   - è´Ÿè´£æ¶ˆæ¯å½’ä¸€åŒ–ã€ä»»åŠ¡åŠ è½½ã€æ¨¡å—ç­›é€‰ã€æ¨¡å—åˆ†å‘ã€‚
2. **Module Execution Chainï¼ˆæ¨¡å—æ‰§è¡Œé“¾ï¼‰**
   - ç”± `ModuleProcessorWithChain` é©±åŠ¨æ¨¡å—å†…éƒ¨ step æµè½¬ä¸é”™è¯¯å›æµã€‚

### 3.1 Task Ingress Chainï¼ˆç»Ÿä¸€å…¥å£ï¼‰

è¾“å…¥ç±»å‹ï¼šTaskModel / ParserTaskModel / ErrorTaskModelï¼ˆç»Ÿä¸€åˆ°åŒä¸€å…¥å£å¤„ç†å™¨ï¼‰

å»ºè®®é˜¶æ®µï¼š

1. NormalizeInputï¼šè¾“å…¥å½’ä¸€åŒ–ä¸ºç»Ÿä¸€ä¸Šä¸‹æ–‡ï¼ˆå« run_idã€prefix_requestã€contextï¼‰ã€‚
2. LoadTaskï¼šæŒ‰è¾“å…¥ç±»å‹åŠ è½½ Taskï¼ˆæ™®é€šä»»åŠ¡ã€è§£æåç»­ä»»åŠ¡ã€é”™è¯¯é‡è¯•ä»»åŠ¡ï¼‰ã€‚
3. ThresholdPreCheckï¼šä»»åŠ¡çº§é˜ˆå€¼é¢„æ£€ï¼ˆä»…å¿«é€Ÿå¤±è´¥ï¼Œå‡å°‘æ— æ•ˆåç»­å¼€é”€ï¼‰ã€‚
4. BuildModulesï¼šåˆ›å»º Module å®ä¾‹å¹¶æ³¨å…¥ metadata/login_infoã€‚
5. ModuleDispatchï¼šæŒ‰æ¨¡å—å¹¶å‘åˆ†å‘åˆ° Module Execution Chainã€‚

### 3.2 Module Execution Chainï¼ˆæ¨¡å—å†…é—­ç¯ï¼‰

ç”± `ModuleProcessorWithChain` æ‰¿æ‹…æ ¸å¿ƒçŠ¶æ€æ¨è¿›ï¼š

1. ResolveExecutionContextï¼ˆ`execute_request` å†…éƒ¨ï¼‰
   - æ ¹æ® `context.step_idx` ä¸ `prefix_request` è§£æå½“å‰ stepã€‚
2. GenerateRequestï¼ˆ`execute_request_impl`ï¼‰
   - ç”Ÿæˆ request streamï¼Œå†™å…¥ request æŒä¹…åŒ–ï¼ˆä¾›å›é€€æ¢å¤ï¼‰ã€‚
3. PublishRequest
   - å‘å¸ƒåˆ°è¯·æ±‚é˜Ÿåˆ—ï¼Œè¿›å…¥ä¸‹è½½é˜¶æ®µã€‚
4. Download + Parse å›è°ƒ
   - ä¸‹è½½å®Œæˆåè¿›å…¥è§£æé“¾ï¼Œè°ƒç”¨ `execute_parser`ã€‚
5. DecisionRouterï¼ˆ`execute_parser` è¾“å‡º ParserDataï¼‰
   - è§£æå¤±è´¥ï¼šè‡ªåŠ¨æ„é€  ErrorTaskModelï¼Œå‘å¸ƒé”™è¯¯é˜Ÿåˆ—ã€‚
   - è§£ææˆåŠŸä¸”æœ‰ä¸‹ä¸€ stepï¼šæ„é€  ParserTaskModelï¼ˆæ¨è¿› stepï¼‰ã€‚
   - è§£ææˆåŠŸä¸”æ— ä¸‹ä¸€ stepï¼šå½“å‰æ¨¡å—ç»“æŸã€‚

---

## 4. å…³é”®èŒè´£åˆ’åˆ†

### 4.1 Task Ingress Chain è´Ÿè´£

- è¾“å…¥å½’ä¸€åŒ–ã€‚
- Task åŠ è½½ã€‚
- ä»»åŠ¡çº§é˜ˆå€¼é¢„æ£€ã€‚
- æ¨¡å—åˆ†å‘å¹¶å‘æ§åˆ¶ã€‚
- å…¥å£çº§ç›‘æ§å’Œå®¡è®¡ã€‚

### 4.2 ModuleProcessorWithChain è´Ÿè´£

- æ¨¡å—å†… step çŠ¶æ€æ¨è¿›ã€‚
- request æŒä¹…åŒ–ä¸ prefix å›é€€ã€‚
- parser æˆåŠŸ/å¤±è´¥å†³ç­–ã€‚
- advance/fallback/stop é—¨é—¸æ§åˆ¶ã€‚
- ç”Ÿæˆ ParserTaskModel æˆ– ErrorTaskModelã€‚

### 4.3 ErrorTask æ¶ˆè´¹é“¾è´Ÿè´£

- æ¨¡å—çº§é˜ˆå€¼åˆ¤å®šã€‚
- ä»»åŠ¡çº§é˜ˆå€¼åˆ¤å®šã€‚
- è¾¾é˜ˆå€¼æ—¶ç»ˆæ­¢å¹¶å¯é€‰è¿›å…¥ DLQã€‚
- æœªè¾¾é˜ˆå€¼æ—¶é‡è¯•ï¼ˆå›åˆ°ç»Ÿä¸€å…¥å£ï¼‰ã€‚

---

## 5. ç»Ÿä¸€çŠ¶æ€æµè½¬

### 5.1 æ­£å¸¸è·¯å¾„

1. æ”¶åˆ° TaskModelã€‚
2. åŠ è½½æ•°æ®åº“ä¿¡æ¯å¹¶åˆ›å»º Module å®ä¾‹ã€‚
3. æ‰§è¡Œ `generate_request` å‘å¸ƒ requestã€‚
4. ä¸‹è½½å®Œæˆè¿›å…¥è§£æã€‚
5. è§£ææˆåŠŸï¼Œ`execute_parser` è¾“å‡º ParserTaskModelã€‚
6. è‹¥å­˜åœ¨ä¸‹ä¸€ ModuleNodeTrait stepï¼Œæ¨è¿›ä¸‹ä¸€ stepï¼›å¦åˆ™æ¨¡å—ç»“æŸã€‚

### 5.2 è§£æå¤±è´¥è·¯å¾„

1. è§£æå¤±è´¥ã€‚
2. `execute_parser` è‡ªåŠ¨ç”Ÿæˆ ErrorTaskModelï¼ˆé™„å½“å‰ step contextã€prefix_requestï¼‰ã€‚
3. ErrorTaskModel å‘å¸ƒåˆ°é”™è¯¯ä»»åŠ¡é˜Ÿåˆ—ã€‚
4. ErrorTask æ¶ˆè´¹å‰æ‰§è¡ŒåŒé˜ˆå€¼åˆ¤å®šï¼š
   - æ¨¡å—çº§é˜ˆå€¼ï¼ˆmodule_idï¼‰
   - ä»»åŠ¡çº§é˜ˆå€¼ï¼ˆtask_idï¼‰
5. åˆ¤å®šç»“æœï¼š
   - æœªè¾¾é˜ˆå€¼ï¼šé‡è¯•ï¼ˆä¿æŒ/æ¢å¤å½“å‰ stepï¼‰ã€‚
   - è¾¾é˜ˆå€¼ï¼šç»ˆæ­¢å½“å‰æ¨¡å—æˆ–ä»»åŠ¡ï¼Œå¹¶è®°å½•ç»ˆæ­¢åŸå› ã€‚

### 5.3 ç”Ÿæˆå¤±è´¥å›é€€è·¯å¾„

1. éé¦– step ç”Ÿæˆå¤±è´¥ã€‚
2. `try_allow_fallback_once` é—¨é—¸åˆ¤å®šã€‚
3. å…è®¸å›é€€æ—¶ï¼Œé€šè¿‡ `prefix_request` æ¢å¤å‰ç½® request é‡è¯•ä¸€æ¬¡ã€‚
4. å›é€€é—¨é—¸å·²ç”¨å°½åˆ™å¤±è´¥ä¸ŠæŠ›ï¼Œé¿å…æ­»å¾ªç¯ã€‚

---

## 6. é˜ˆå€¼åˆ¤å®šç­–ç•¥ï¼ˆå»ºè®®ï¼‰

### 6.1 åˆ¤å®šé¡ºåº

1. æ¨¡å—çº§ä¼˜å…ˆï¼ˆç²’åº¦æ›´ç»†ï¼Œèƒ½é¿å…æ‹–ç´¯æ•´ä»»åŠ¡ï¼‰ã€‚
2. ä»»åŠ¡çº§å…œåº•ï¼ˆé˜²æ­¢å…¨å±€é›ªå´©ï¼‰ã€‚

### 6.2 åˆ¤å®šæ—¶æœº

- å…¥å£é“¾ï¼šä»»åŠ¡çº§å¿«é€Ÿé¢„æ£€ï¼ˆé™ä½æ— æ•ˆæ‰§è¡Œï¼‰ã€‚
- ErrorTask æ¶ˆè´¹é“¾ï¼šæ¨¡å—çº§ + ä»»åŠ¡çº§ä¸¥æ ¼åˆ¤å®šï¼ˆæœ€ç»ˆå†³ç­–ç‚¹ï¼‰ã€‚

### 6.3 åˆ¤å®šç»“æœè¯­ä¹‰

- Continueï¼šå…è®¸ç»§ç»­ã€‚
- RetryAfterï¼ˆå¯é€‰æ‰©å±•ï¼‰ï¼šå»¶è¿Ÿé‡è¯•ã€‚
- Terminate(module)ï¼šç»ˆæ­¢è¯¥æ¨¡å—åç»­ã€‚
- Terminate(task)ï¼šç»ˆæ­¢æ•´ä¸ªä»»åŠ¡ runã€‚

---

## 7. æ•°æ®å¥‘çº¦ä¸ä¸Šä¸‹æ–‡çº¦æŸ

### 7.1 å¿…é¡»ä¿è¯çš„å­—æ®µ

- `run_id`ï¼šå…¨é“¾è·¯ä¸€è‡´ã€‚
- `context.module_id`ï¼šå¿…é¡»å¯å®šä½å½“å‰æ¨¡å—ã€‚
- `context.step_idx`ï¼šå¿…é¡»å¯å®šä½å½“å‰ stepã€‚
- `prefix_request`ï¼šé“¾å¼å›é€€å’Œæ­¥é—´å…³è”å…³é”®å­—æ®µã€‚

### 7.2 ErrorTaskModel çº¦æŸ

- `context.stay_current_step = true`ï¼ˆè¡¨ç¤ºé‡è¯•å½“å‰ stepï¼‰ã€‚
- `prefix_request` å¿…é¡»ä¿ç•™ï¼ˆç”¨äºå›é€€æˆ–é”™è¯¯å½’å› ï¼‰ã€‚
- `metadata` ä¿æŒé€ä¼ ï¼Œä¸å†™å…¥â€œä¸´æ—¶é‡è¯•æ§åˆ¶å­—æ®µâ€ä»¥å…æ±¡æŸ“ä¸šåŠ¡å…ƒæ•°æ®ã€‚

---

## 8. é”™è¯¯è¯­ä¹‰ç»Ÿä¸€å»ºè®®

- å…¥å£é“¾ä¸­ï¼Œå…³é”®æ­¥éª¤ï¼ˆLoadTask / BuildModulesï¼‰å¤±è´¥ä¸å»ºè®®ä½¿ç”¨ Skipã€‚
- æ¨¡å—æ‰§è¡Œé“¾ä¸­ï¼Œç”Ÿæˆ/å‘å¸ƒå¤±è´¥è¦æ˜ç¡®å¯é‡è¯•è¿˜æ˜¯ç»ˆæ­¢ï¼Œç¦æ­¢é™é»˜ä¸¢å¼ƒã€‚
- å¯¹äºæµå¼é˜¶æ®µï¼Œå»ºè®®é‡‡ç”¨â€œå¯è¿”å›ç»“æœâ€çš„ç­–ç•¥ï¼Œé¿å… RetryableFailure è¢«è¯¯åã€‚

å»ºè®®è§„åˆ™ï¼š

1. å¯æ¢å¤é”™è¯¯ -> RetryableFailureã€‚
2. ä¸å¯æ¢å¤é”™è¯¯ -> FatalFailure + ç»ˆæ­¢è®°å½•ã€‚
3. ä¸šåŠ¡å¯è·³è¿‡é¡¹ï¼ˆå¦‚å•æ¡æ•°æ®è„æ•°æ®ï¼‰-> æ˜¾å¼è®°å½•å Skipã€‚

---

## 9. å¹¶å‘ä¸èƒŒå‹ç­–ç•¥

### 9.1 å¹¶å‘é…ç½®ç»Ÿä¸€

ä¸è¦åœ¨ä¸åŒé“¾è·¯é‡Œç¡¬ç¼–ç å¹¶å‘å€¼ï¼Œç»Ÿä¸€ç”±é…ç½®é©±åŠ¨ï¼š

- task_concurrency
- publish_concurrency
- parser_concurrencyï¼ˆå»ºè®®æ–°å¢ï¼‰
- error_task_concurrencyï¼ˆå»ºè®®æ–°å¢ï¼‰

### 9.2 èƒŒå‹æ§åˆ¶

- è¯·æ±‚å‘å¸ƒé˜Ÿåˆ—æ»¡æ—¶ï¼Œé‡‡ç”¨å¯è§‚æµ‹çš„é™çº§ç­–ç•¥ï¼ˆé˜»å¡ç­‰å¾…/é™æµ/å»¶è¿Ÿé‡è¯•ï¼‰ã€‚
- è®°å½•é˜Ÿåˆ—ç§¯å‹æŒ‡æ ‡ï¼Œè¶…è¿‡é˜ˆå€¼æ—¶åŠ¨æ€é™ä½æ¨¡å—å¹¶å‘ã€‚

---

## 10. å¯è§‚æµ‹æ€§ä¸å®¡è®¡

### 10.1 å¿…å¤‡æŒ‡æ ‡

- task_ingress_total / task_ingress_failed_total
- module_step_generate_total / module_step_generate_failed_total
- parser_success_total / parser_failed_total
- error_task_emitted_total / error_task_retry_total / error_task_terminated_total
- fallback_gate_hit_total / fallback_gate_block_total
- advance_gate_win_total / advance_gate_lost_total

### 10.2 æ—¥å¿—è§„èŒƒ

ç»Ÿä¸€æ‰“å°ï¼š

- run_id
- task_id
- module_id
- step_idx
- request_id
- prefix_request
- decisionï¼ˆcontinue/retry/terminateï¼‰

### 10.3 äº‹ä»¶è¯­ä¹‰

å»ºè®®åœ¨äº‹ä»¶æ€»çº¿ä¸Šæ˜¾å¼åŒºåˆ†ï¼š

- ParserTaskProduced
- ErrorTaskProduced
- ModuleStepAdvanced
- ModuleStepFallback
- TaskTerminatedByThreshold

---

## 11. è¿ç§»æ–¹æ¡ˆï¼ˆåˆ†é˜¶æ®µï¼‰

### é˜¶æ®µ Aï¼šå¼•å…¥ç»Ÿä¸€å…¥å£ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰

- æ–°å¢ç»Ÿä¸€å…¥å£é“¾ï¼Œä½†ä¿ç•™æ—§ `create_parser_task_chain` ä¸ `create_error_task_chain`ã€‚
- é€šè¿‡é…ç½®å¼€å…³æŒ‰æµé‡æ¯”ä¾‹åˆ‡æ¢ã€‚

### é˜¶æ®µ Bï¼šæ¨¡å—é—­ç¯æ”¶æ•›

- å°† step æ¨è¿›/å›é€€åˆ¤å®šç»Ÿä¸€ä¸‹æ²‰è‡³ `ModuleProcessorWithChain`ã€‚
- å…¥å£é“¾ä»…åšåˆ†å‘ï¼Œä¸åš step ä¸šåŠ¡å†³ç­–ã€‚

### é˜¶æ®µ Cï¼šé˜ˆå€¼ä¸é”™è¯¯è¯­ä¹‰æ”¶æ•›

- åŒé˜ˆå€¼åˆ¤å®šå›ºå®šåˆ° ErrorTask æ¶ˆè´¹é“¾ã€‚
- ç§»é™¤æ—§é“¾è·¯ä¸­é‡å¤åˆ¤å®šä»£ç ã€‚

### é˜¶æ®µ Dï¼šæ¸…ç†ä¸å›ºåŒ–

- ä¸‹çº¿æ—§ parser/error ä¸“ç”¨é“¾ã€‚
- å›ºåŒ–äº‹ä»¶å’ŒæŒ‡æ ‡é¢æ¿ã€‚
- æ›´æ–°è¿ç»´æ‰‹å†Œã€‚

---

## 12. éªŒè¯æ–¹æ¡ˆ

### 12.1 åŠŸèƒ½æµ‹è¯•

- å¤š step æ­£å¸¸æ¨è¿›åˆ°ç»“æŸã€‚
- ä¸­é—´ step è§£æå¤±è´¥èƒ½ç”Ÿæˆ ErrorTaskModel å¹¶é‡è¯•å½“å‰ stepã€‚
- è¾¾æ¨¡å—é˜ˆå€¼ååªç»ˆæ­¢æ¨¡å—ï¼Œä»»åŠ¡å¯ç»§ç»­å…¶å®ƒæ¨¡å—ã€‚
- è¾¾ä»»åŠ¡é˜ˆå€¼åç»ˆæ­¢æ•´ä¸ªä»»åŠ¡ã€‚

### 12.2 ç¨³å®šæ€§æµ‹è¯•

- é«˜å¹¶å‘ä¸‹ gate ä¸é‡å¤æ¨è¿›ã€‚
- å›é€€é—¨é—¸é˜²æ­¢æ— é™å¾ªç¯ã€‚
- é˜Ÿåˆ—ç§¯å‹æ—¶ä¸å‡ºç°å¤§è§„æ¨¡é™é»˜ä¸¢æ¶ˆæ¯ã€‚

### 12.3 å›å½’é‡ç‚¹

- run_id / context / prefix_request ä¸€è‡´æ€§ã€‚
- æ—§ä»»åŠ¡æ¨¡å‹åˆ°æ–°å…¥å£çš„å…¼å®¹æ€§ã€‚
- ç›‘æ§æŒ‡æ ‡ä¸å‘Šè­¦å‡†ç¡®æ€§ã€‚

---

## 13. é£é™©ä¸å›æ»š

### 13.1 é£é™©

- ç»Ÿä¸€å…¥å£åˆæœŸå¯èƒ½å¼•å…¥æµé‡çƒ­ç‚¹ã€‚
- é˜ˆå€¼ç­–ç•¥åˆ‡æ¢å¯èƒ½æ”¹å˜å†å²è¡Œä¸ºã€‚
- æ—§é“¾ä¸æ–°é“¾å¹¶è¡ŒæœŸé—´å¯èƒ½å‡ºç°é‡å¤æ¶ˆè´¹ã€‚

### 13.2 å›æ»šç­–ç•¥

- ä¿ç•™æ—§é“¾è·¯å¼€å…³ï¼Œå‡ºç°å¼‚å¸¸å¯ç§’çº§åˆ‡å›ã€‚
- ä¿ç•™å…³é”®çŠ¶æ€å­—æ®µå…¼å®¹è¯»å†™ï¼ˆrun_id/context/prefix_requestï¼‰ã€‚
- å¯¹æ–°é“¾è·¯äº‹ä»¶å¢åŠ ç‰ˆæœ¬å·ï¼Œä¾¿äºç°åº¦éš”ç¦»ã€‚

---

## 14. è½åœ°åçš„ä»£ç ç»“æ„å»ºè®®

- ä¿ç•™å¹¶å¼ºåŒ–ï¼š`ModuleProcessorWithChain`ï¼ˆæ¨¡å—å†…å”¯ä¸€ç¼–æ’å™¨ï¼‰
- æ”¶æ•›å…¥å£ï¼š`task_model_chain` ç»Ÿä¸€å…¥å£å·¥å‚
- ä¸‹çº¿æˆ–å…¼å®¹å£³åŒ–ï¼š`create_parser_task_chain`ã€`create_error_task_chain`
- æ–°å¢ï¼ˆå»ºè®®ï¼‰ï¼š
  - UnifiedTaskInput å½’ä¸€åŒ–ç±»å‹
  - ThresholdDecisionServiceï¼ˆç»Ÿä¸€é˜ˆå€¼åˆ¤å®šï¼‰
  - ChainDecisionRouterï¼ˆç»Ÿä¸€å†³ç­–è¯­ä¹‰ï¼‰

---

## 15. ç»“è®º

è¯¥æ–¹æ¡ˆå°†å½“å‰â€œå¤šé“¾è·¯é‡å¤ç¼–æ’â€æ”¶æ•›ä¸ºâ€œç»Ÿä¸€å…¥å£ + æ¨¡å—å†…é—­ç¯â€ï¼Œå……åˆ†åˆ©ç”¨ `ModuleProcessorWithChain` å·²å…·å¤‡çš„ step ç®¡ç†èƒ½åŠ›ï¼Œå®ç°ï¼š

- æ›´æ¸…æ™°çš„èŒè´£è¾¹ç•Œ
- æ›´ä¸€è‡´çš„é”™è¯¯ä¸é‡è¯•è¯­ä¹‰
- æ›´å¯æ§çš„é˜ˆå€¼æ²»ç†
- æ›´å¯è§‚æµ‹çš„è¿è¡ŒçŠ¶æ€

åœ¨ä¸æ”¹åŠ¨æ ¸å¿ƒä¸šåŠ¡è§£æé€»è¾‘çš„å‰æä¸‹ï¼Œå¯é€šè¿‡ç°åº¦æ–¹å¼é€æ­¥å®Œæˆé‡æ„ï¼Œé£é™©å¯æ§ã€‚

---

## 16. åˆ†å¸ƒå¼å¹‚ç­‰ä¸ä¸€è‡´æ‰§è¡Œè®¾è®¡ï¼ˆParserTaskModelï¼‰

> ç›®æ ‡ï¼šåœ¨å¤šèŠ‚ç‚¹å¹¶å‘æ¶ˆè´¹ä¸‹ï¼Œä»»æ„èŠ‚ç‚¹æ”¶åˆ°åŒä¸€ä¸ª ParserTaskModelï¼Œæ‰§è¡Œçš„ ModuleNodeTrait step å¿…é¡»ä¸€è‡´ï¼Œä¸”ä¸ä¼šé‡å¤æ¨è¿›ã€‚

### 16.1 ä¸€è‡´æ€§ç›®æ ‡å®šä¹‰

1. **Step ä¸€è‡´æ€§**ï¼šåŒä¸€é€»è¾‘ä»»åŠ¡åªèƒ½åœ¨åŒä¸€ `module_id + step_idx` ä¸Šæ‰§è¡Œã€‚
2. **æ¨è¿›å¹‚ç­‰æ€§**ï¼šåŒä¸€ step åˆ°ä¸‹ä¸€ step çš„æ¨è¿›è‡³å¤šä¸€æ¬¡ï¼ˆat-most-once advanceï¼‰ã€‚
3. **æ¶ˆè´¹å¹‚ç­‰æ€§**ï¼šæ¶ˆæ¯å¯é‡å¤æŠ•é€’ï¼Œä½†ä¸šåŠ¡çŠ¶æ€ä¸å¯é‡å¤å˜æ›´ï¼ˆexactly-once logical effectï¼‰ã€‚
4. **é¡ºåºçº¦æŸ**ï¼šå…è®¸ç½‘ç»œä¹±åºåˆ°è¾¾ï¼Œä½†çŠ¶æ€æœºåªæ¥å—åˆæ³•è¿ç§»ã€‚

### 16.2 ç»Ÿä¸€å¹‚ç­‰é”®ï¼ˆIdentityï¼‰

å»ºè®®ä¸º ParserTaskModel å®šä¹‰ç¨³å®šçš„å¹‚ç­‰ä¸»é”®ï¼ˆ`ptm_key`ï¼‰ï¼š

`ptm_key = hash(run_id + account + platform + module_id + step_idx + prefix_request)`

è¯´æ˜ï¼š

- `run_id`ï¼šä¿è¯åŒä¸€è½®è¿è¡Œå†…å”¯ä¸€ã€‚
- `module_id + step_idx`ï¼šçº¦æŸæ‰§è¡ŒèŠ‚ç‚¹ã€‚
- `prefix_request`ï¼šåŒºåˆ†åŒ step çš„ä¸åŒé“¾è·¯åˆ†æ”¯ã€‚

è¯¥é”®ç”¨äºåˆ†å¸ƒå¼é”ã€çŠ¶æ€è®°å½•ã€å»é‡åˆ¤æ–­ã€äº‹ä»¶è¿½è¸ªã€‚

### 16.3 åˆ†å¸ƒå¼çŠ¶æ€å­˜å‚¨æ¨¡å‹ï¼ˆRedisï¼‰

å»ºè®®æ–°å¢ä¸‰ç±»çŠ¶æ€ï¼ˆå¯æŒ‰ç°æœ‰ CacheAble ä½“ç³»å®ç°ï¼‰ï¼š

1. **æ‰§è¡ŒçŠ¶æ€ï¼ˆExecution Stateï¼‰**
   - Key: `chain:exec:{run_id}:{module_id}`
   - å­—æ®µï¼š
     - `committed_step`ï¼ˆå·²æäº¤æ­¥ï¼‰
     - `inflight_step`ï¼ˆæ‰§è¡Œä¸­æ­¥ï¼‰
     - `version`ï¼ˆfencing tokenï¼‰
     - `updated_at`

2. **æ¶ˆæ¯å»é‡çŠ¶æ€ï¼ˆMessage Dedupï¼‰**
   - Key: `chain:ptm:{ptm_key}`
   - å€¼ï¼š`pending | processing | done | failed`
   - TTLï¼šè¦†ç›–æœ€å¤§é‡è¯•çª—å£ã€‚

3. **æ¨è¿›é—¨é—¸ï¼ˆAdvance Gateï¼‰**
   - å¤ç”¨ç°æœ‰ `AdvanceGate`ï¼Œä½†å»ºè®®å°†ç²’åº¦å‡çº§ä¸ºï¼š
     - `run_id + module_id + from_step + to_step + prefix_request`
   - é˜²æ­¢ä¸åŒæ¥æºæ¶ˆæ¯é‡å¤æ¨è¿›åŒä¸€è·³ã€‚

### 16.4 åŸå­çŠ¶æ€æœºï¼ˆCAS + Luaï¼‰

ä»»ä½•èŠ‚ç‚¹åœ¨æ‰§è¡Œ ParserTaskModel å‰ï¼Œå…ˆæ‰§è¡ŒåŸå­æ ¡éªŒè„šæœ¬ï¼ˆå»ºè®® Luaï¼‰ï¼š

è¾“å…¥ï¼š`ptm_key, expected_step, module_id, run_id, lease_owner, now`

åŸå­è§„åˆ™ï¼š

1. è‹¥ `chain:ptm:{ptm_key}=done` -> ç›´æ¥ä¸¢å¼ƒï¼ˆå¹‚ç­‰å‘½ä¸­ï¼‰ã€‚
2. è‹¥ `expected_step < committed_step` -> ä¸¢å¼ƒï¼ˆè¿‡æœŸæ¶ˆæ¯ï¼‰ã€‚
3. è‹¥ `expected_step > committed_step + 1` -> æš‚ç¼“/é‡æ’ï¼ˆä¹±åºæ¶ˆæ¯ï¼‰ã€‚
4. è‹¥ `expected_step == committed_step + 1` ä¸” gate æœªå ç”¨ -> æŠ¢å æ‰§è¡Œæƒï¼Œå†™ `processing`ã€‚
5. æŠ¢å æˆåŠŸåè¿”å› `EXECUTE`ï¼Œå¦åˆ™è¿”å› `SKIP/RETRY`ã€‚

æäº¤é˜¶æ®µå†æ‰§è¡Œç¬¬äºŒä¸ªåŸå­è„šæœ¬ï¼š

1. æ ¡éªŒ `lease_owner` ä¸ `version`ï¼ˆfencingï¼‰ã€‚
2. `committed_step = expected_step`ã€‚
3. `chain:ptm:{ptm_key}=done`ã€‚
4. å†™å…¥ `next ParserTaskModel`ï¼ˆè‹¥å­˜åœ¨ä¸‹ä¸€æ­¥ï¼‰æˆ–æ¨¡å—å®Œæˆæ ‡è®°ã€‚

### 16.5 åˆ†å¸ƒå¼é”ä¸ Fencing Token

ä»…ä½¿ç”¨ NX é”ä¸è¶³ä»¥é¿å…â€œé”è¶…æ—¶åæ—§æŒæœ‰è€…ç»§ç»­å†™å…¥â€çš„é—®é¢˜ï¼Œå»ºè®®å¼•å…¥ fencing tokenï¼š

1. æŠ¢é”æˆåŠŸæ—¶è¿”å›è‡ªå¢ `version`ã€‚
2. åç»­æ‰€æœ‰å†™æ“ä½œå¿…é¡»æºå¸¦è¯¥ `version`ã€‚
3. å­˜å‚¨å±‚åªæ¥å— `version >= current_version` çš„å†™å…¥ã€‚

è¿™æ ·å³ä½¿æ—§èŠ‚ç‚¹å› ä¸º GC/ç½‘ç»œæŠ–åŠ¨å¯¼è‡´é”å¤±æ•ˆåç»§ç»­æ‰§è¡Œï¼Œä¹Ÿæ— æ³•è¦†ç›–æ–°èŠ‚ç‚¹ç»“æœã€‚

### 16.6 ä¸ ModuleProcessorWithChain çš„é›†æˆç‚¹

å»ºè®®åœ¨ä»¥ä¸‹æ–¹æ³•å†…è¡¥å……åˆ†å¸ƒå¼ä¸€è‡´æ€§æ ¡éªŒï¼š

1. `resolve_execution_context`
   - ä»æƒå¨çŠ¶æ€è¯»å– `committed_step`ï¼Œæ ¡éªŒå…¥å‚ `context.step_idx`ã€‚
2. `execute_request_impl`
   - ç”Ÿæˆå‰å…ˆå ç”¨ `inflight_step`ï¼ˆå¸¦ lease/versionï¼‰ã€‚
3. `execute_parser`
   - è§£ææˆåŠŸæ¨è¿›å‰ï¼Œèµ° `try_mark_step_advanced_once + CAS æäº¤` åŒä¿é™©ã€‚
4. ErrorTaskModel ç”Ÿæˆ
   - ä½¿ç”¨åŒä¸€ `ptm_key` æ´¾ç”Ÿé”™è¯¯é”®ï¼Œé¿å…åŒä¸€å¤±è´¥é‡å¤å…¥é”™é˜Ÿåˆ—ã€‚

### 16.7 å¤šèŠ‚ç‚¹æ¶ˆè´¹ç­–ç•¥

é˜Ÿåˆ—å±‚å»ºè®®ç»´æŒè‡³å°‘ä¸€æ¬¡æŠ•é€’ï¼ˆat-least-onceï¼‰ï¼Œä¸šåŠ¡å±‚ç¡®ä¿å¹‚ç­‰ï¼š

1. èŠ‚ç‚¹æ”¶åˆ°æ¶ˆæ¯ -> å…ˆ `Claim(ptm_key)`ã€‚
2. Claim å¤±è´¥ -> ç«‹å³ ackï¼ˆé‡å¤æ¶ˆæ¯ï¼‰ã€‚
3. Claim æˆåŠŸ -> æ‰§è¡Œä¸šåŠ¡ã€‚
4. æäº¤æˆåŠŸ -> æ ‡è®° done å¹¶ ackã€‚
5. æäº¤å¤±è´¥ -> ä¸ ack æˆ–å†™ retryï¼ˆç”±ç­–ç•¥å†³å®šï¼‰ã€‚

### 16.8 æ•…éšœæ¢å¤ç­–ç•¥

1. **èŠ‚ç‚¹å®•æœºï¼ˆprocessing ä¸­æ–­ï¼‰**
   - ä¾èµ– lease è¶…æ—¶å›æ”¶ï¼Œå…¶ä»–èŠ‚ç‚¹å¯é‡æ–° claimã€‚
2. **æäº¤æˆåŠŸä½† ack å¤±è´¥**
   - é‡å¤æŠ•é€’æ—¶å‘½ä¸­ `done` å»é‡ï¼Œå®‰å…¨è·³è¿‡ã€‚
3. **ä¹±åºæ¶ˆæ¯å…ˆåˆ°**
   - è¿›å…¥å»¶æœŸé˜Ÿåˆ—æˆ–çŸ­æœŸé‡è¯•ï¼Œç­‰å¾…å‰ç½® step æäº¤ã€‚
4. **é•¿æ—¶é—´å¡æ­»**
   - é€šè¿‡ `processing_age` æŒ‡æ ‡è§¦å‘æ‰«æå™¨ï¼Œå°†åƒµå°¸æ‰§è¡Œè½¬ä¸º retryã€‚

### 16.9 å»ºè®®æ–°å¢æŒ‡æ ‡

- `ptm_claim_total{result=success|duplicate|stale|out_of_order}`
- `ptm_commit_total{result=success|fencing_reject|cas_conflict}`
- `ptm_processing_duration_ms`
- `ptm_zombie_recover_total`
- `ptm_reorder_buffer_size`

### 16.10 å…¼å®¹è½åœ°é¡ºåº

1. å…ˆåŠ  `ptm_key` ä¸ `done` å»é‡ï¼ˆä½é£é™©ï¼‰ã€‚
2. å†åŠ  `committed_step` CAS æ ¡éªŒï¼ˆä¿è¯ step ä¸€è‡´ï¼‰ã€‚
3. æœ€åå¼•å…¥ fencing tokenï¼ˆè§£å†³é”æ¼‚ç§»å†™è¦†ç›–ï¼‰ã€‚

åˆ†é˜¶æ®µä¸Šçº¿å¯ä»¥åœ¨ä¸å½±å“ç°æœ‰ä¸šåŠ¡é€»è¾‘çš„å‰æä¸‹ï¼Œé€æ­¥æŠŠ ParserTaskModel æå‡åˆ°â€œåˆ†å¸ƒå¼å¯è¯æ˜å¹‚ç­‰â€ã€‚

### 16.11 Lua-first åŸå­äº¤äº’åŸåˆ™ï¼ˆParserTaskModel + ErrorTaskModelï¼‰

ç”±äº ParserTaskModel ä¸ ErrorTaskModel åœ¨é«˜å¹¶å‘ä¸‹ä¼šå‘ç”Ÿå¤§é‡ Redis äº¤äº’ï¼Œå»ºè®®é‡‡ç”¨ **Lua-first** æ¨¡å¼ï¼š

1. **ä¸šåŠ¡ä¾§ä¸ç›´æ¥åšå¤šæ¬¡ GET/SET ç»„åˆ**ï¼Œç»Ÿä¸€æ”¹ä¸º Lua è„šæœ¬äº‹åŠ¡åŒ–ã€‚
2. æ¯ä¸ªçŠ¶æ€è¿ç§»ï¼ˆclaim/commit/retry/terminateï¼‰éƒ½å¿…é¡»ç”±å•è„šæœ¬å®Œæˆã€‚
3. è„šæœ¬è¿”å›ç»Ÿä¸€çŠ¶æ€ç ï¼Œä¸šåŠ¡å±‚åªåšåˆ†æ”¯å¤„ç†ï¼Œä¸å†äºŒæ¬¡åˆ¤å®š Redis ç»†èŠ‚ã€‚
4. æ‰€æœ‰å¹‚ç­‰é”®ã€æ‰§è¡ŒçŠ¶æ€é”®ã€é˜ˆå€¼é”®éƒ½é€šè¿‡ `KEYS[]` æ˜¾å¼ä¼ å…¥ï¼Œé¿å…è„šæœ¬å†…æ‹¼æ¥å‡ºé”™ã€‚

æ¨èçº¦æŸï¼š

- å…³é”®è·¯å¾„è„šæœ¬éƒ½ç”¨ `EVALSHA`ï¼ˆå¯åŠ¨æ—¶é¢„çƒ­åŠ è½½ SHAï¼‰ã€‚
- æ‰€æœ‰è„šæœ¬è¿”å›ç»“æ„ç»Ÿä¸€ä¸ºï¼š`{code, msg, payload_json}`ã€‚
- æ‰€æœ‰å†™å…¥å¿…é¡»å¸¦ TTL æˆ–ç”±ä¸Šå±‚ç»Ÿä¸€æ¸…ç†ç­–ç•¥ç®¡ç†ã€‚

### 16.12 è„šæœ¬ç›®å½•ï¼ˆå»ºè®®ï¼‰

ä»¥ä¸‹è„šæœ¬è¦†ç›– ParserTaskModel / ErrorTaskModel çš„ä¸»è¦äº¤äº’ã€‚

#### A. ParserTaskModel è„šæœ¬

1. **`ptm_claim.lua`**ï¼ˆæŠ¢å æ‰§è¡Œæƒï¼‰
    - ç›®æ ‡ï¼šå¹‚ç­‰å»é‡ + step åˆæ³•æ€§æ ¡éªŒ + inflight å ä½ã€‚
    - åŸå­åŠ¨ä½œï¼š
       - æ£€æŸ¥ `ptm_dedup_key` æ˜¯å¦ `done`ã€‚
       - æ£€æŸ¥ `expected_step` ä¸ `committed_step` å…³ç³»ã€‚
       - å°è¯•å†™å…¥ `processing + lease_owner + lease_expire_at + version`ã€‚
    - è¿”å›ç å»ºè®®ï¼š
       - `0 EXECUTE`
       - `1 DUPLICATE_DONE`
       - `2 STALE_STEP`
       - `3 OUT_OF_ORDER`
       - `4 LOCKED_BY_OTHER`

2. **`ptm_commit_success.lua`**ï¼ˆè§£ææˆåŠŸæäº¤ï¼‰
    - ç›®æ ‡ï¼šæäº¤å½“å‰ stepï¼Œæ¨è¿›ä¸‹ä¸€ stepï¼ˆå¯é€‰ï¼‰ï¼Œå¹¶å†™ doneã€‚
    - åŸå­åŠ¨ä½œï¼š
       - æ ¡éªŒ `lease_owner + version`ï¼ˆfencingï¼‰ã€‚
       - æ›´æ–° `committed_step`ã€‚
       - `ptm_dedup_key=done`ã€‚
       - å†™å…¥ `advance_gate`ï¼ˆfrom->toï¼Œé˜²é‡å¤æ¨è¿›ï¼‰ã€‚
       - å¯é€‰ï¼šå†™ `next_parser_task` çš„è½»é‡ç´¢å¼•ã€‚
    - è¿”å›ç ï¼š
       - `0 COMMIT_OK`
       - `1 FENCING_REJECT`
       - `2 CAS_CONFLICT`
       - `3 ALREADY_COMMITTED`

3. **`ptm_commit_error.lua`**ï¼ˆè§£æå¤±è´¥æäº¤ï¼‰
    - ç›®æ ‡ï¼šå¤±è´¥çŠ¶æ€è½ç›˜ + äº§å‡º ErrorTaskModel å¹‚ç­‰ç´¢å¼•ã€‚
    - åŸå­åŠ¨ä½œï¼š
       - æ ¡éªŒ ownership/versionã€‚
       - å†™ `ptm_dedup_key=failed`ã€‚
       - å†™ `error_emit_key`ï¼ˆä¿è¯åŒä¸€å¤±è´¥åªäº§å‡ºä¸€æ¬¡é”™è¯¯ä»»åŠ¡ï¼‰ã€‚
       - å†™é”™è¯¯ä¸Šä¸‹æ–‡ï¼ˆstep/prefix/error_hashï¼‰ã€‚
    - è¿”å›ç ï¼š
       - `0 ERROR_EMIT_OK`
       - `1 ERROR_ALREADY_EMITTED`
       - `2 FENCING_REJECT`

4. **`ptm_recover_zombie.lua`**ï¼ˆåƒµå°¸æ‰§è¡Œå›æ”¶ï¼‰
    - ç›®æ ‡ï¼šlease è¶…æ—¶åå®‰å…¨å›æ”¶ processing çŠ¶æ€ã€‚
    - åŸå­åŠ¨ä½œï¼š
       - è‹¥ `now > lease_expire_at` ä¸”çŠ¶æ€ `processing`ï¼Œè½¬ `pending`ã€‚
       - å¢åŠ  zombie è®¡æ•°ï¼Œè®°å½•æœ€åå›æ”¶æ—¶é—´ã€‚
    - è¿”å›ç ï¼š
       - `0 RECOVERED`
       - `1 NOT_EXPIRED`
       - `2 NOT_PROCESSING`

5. **`ptm_reorder_enqueue.lua`**ï¼ˆä¹±åºæ¶ˆæ¯æš‚å­˜ï¼‰
    - ç›®æ ‡ï¼š`expected_step > committed_step + 1` æ—¶åŸå­å…¥é‡æ’ç¼“å†²ã€‚
    - åŸå­åŠ¨ä½œï¼š
       - å»é‡æ’å…¥ `reorder_zset`ï¼ˆscore=step_idxï¼‰ã€‚
       - å†™æ¶ˆæ¯æ‘˜è¦ï¼ˆé¿å…å…¨é‡é‡å¤å†™ï¼‰ã€‚
    - è¿”å›ç ï¼š
       - `0 ENQUEUED`
       - `1 DUPLICATE_BUFFERED`

#### B. ErrorTaskModel è„šæœ¬

1. **`etm_threshold_decide.lua`**ï¼ˆåŒé˜ˆå€¼åˆ¤å®šæ ¸å¿ƒè„šæœ¬ï¼‰
    - ç›®æ ‡ï¼šæ¨¡å—çº§ + ä»»åŠ¡çº§è®¡æ•°ä¸å†³ç­–ä¸€æ¬¡å®Œæˆï¼Œé¿å…ç«æ€ã€‚
    - åŸå­åŠ¨ä½œï¼š
       - å¢åŠ  `module_error_count` ä¸ `task_error_count`ã€‚
       - æ¯”è¾ƒé˜ˆå€¼å¹¶å†™æœ€ç»ˆå†³ç­–ï¼ˆcontinue/retry/terminate_module/terminate_taskï¼‰ã€‚
       - å†™å†·å´æ—¶é—´ï¼ˆå¯é€‰ RetryAfterï¼‰ã€‚
    - è¿”å›ç ï¼š
       - `0 CONTINUE`
       - `1 RETRY_AFTER`
       - `2 TERMINATE_MODULE`
       - `3 TERMINATE_TASK`

2. **`etm_retry_schedule.lua`**ï¼ˆé‡è¯•è°ƒåº¦ï¼‰
    - ç›®æ ‡ï¼šæŒ‰é€€é¿ç­–ç•¥åŸå­å…¥é‡è¯•é˜Ÿåˆ—ã€‚
    - åŸå­åŠ¨ä½œï¼š
       - æ ¡éªŒå½“å‰å†³ç­–å…è®¸é‡è¯•ã€‚
       - è®¡ç®—ä¸‹ä¸€æ¬¡é‡è¯•æ—¶é—´å¹¶å†™å…¥å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆzsetï¼‰ã€‚
       - å¢åŠ  retry æ¬¡æ•°ã€‚
    - è¿”å›ç ï¼š
       - `0 RETRY_SCHEDULED`
       - `1 RETRY_NOT_ALLOWED`
       - `2 MAX_RETRY_EXCEEDED`

3. **`etm_terminate_mark.lua`**ï¼ˆç»ˆæ­¢æ ‡è®°ï¼‰
    - ç›®æ ‡ï¼šç»ˆæ­¢æ¨¡å—/ä»»åŠ¡å¹¶é˜»æ–­åç»­é‡å¤å¤„ç†ã€‚
    - åŸå­åŠ¨ä½œï¼š
       - å†™ `task_terminate_key` æˆ– `module_terminate_key`ã€‚
       - å†™ç»ˆæ­¢åŸå› ä¸æ—¶é—´æˆ³ã€‚
       - å†™å¹‚ç­‰ç»ˆæ­¢æ ‡å¿—ï¼Œé¿å…é‡å¤ç»ˆæ­¢äº‹ä»¶ã€‚
    - è¿”å›ç ï¼š
       - `0 TERMINATED`
       - `1 ALREADY_TERMINATED`

### 16.13 è„šæœ¬è¾“å…¥é”®è§„èŒƒï¼ˆå»ºè®®ï¼‰

ä¸ºé¿å…è·¨è„šæœ¬é”®æ ¼å¼æ¼‚ç§»ï¼Œå»ºè®®ç»Ÿä¸€ key builderï¼š

- `chain:exec:{run_id}:{module_id}`
- `chain:ptm:{ptm_key}`
- `chain:gate:advance:{run_id}:{module_id}:{from}:{to}:{prefix}`
- `chain:error:emit:{run_id}:{module_id}:{step}:{prefix}:{error_hash}`
- `chain:threshold:module:{task_id}:{module_id}`
- `chain:threshold:task:{task_id}`
- `chain:terminate:task:{task_id}`
- `chain:terminate:module:{task_id}:{module_id}`

å»ºè®®æŠŠä¸Šè¿° key è§„åˆ™å›ºåŒ–åˆ°ä¸€ä¸ªå…¬å…±æ¨¡å—ï¼Œè„šæœ¬ä¸ Rust ç«¯å…±ç”¨åŒä¸€æ„é€ é€»è¾‘ã€‚

### 16.14 æ‰§è¡Œæ—¶åºï¼ˆå»ºè®®ï¼‰

#### ParserTaskModel æ¶ˆè´¹æ—¶åº

1. `ptm_claim.lua`
2. è‹¥ `EXECUTE` -> æ‰§è¡Œä¸šåŠ¡è§£æ
3. è§£ææˆåŠŸ -> `ptm_commit_success.lua`
4. è§£æå¤±è´¥ -> `ptm_commit_error.lua`ï¼ˆè§¦å‘ ErrorTaskModel ç´¢å¼•ï¼‰

#### ErrorTaskModel æ¶ˆè´¹æ—¶åº

1. `etm_threshold_decide.lua`
2. è‹¥ `CONTINUE/RETRY_AFTER` -> `etm_retry_schedule.lua`
3. è‹¥ `TERMINATE_*` -> `etm_terminate_mark.lua`

### 16.15 å·¥ç¨‹åŒ–å»ºè®®

1. è„šæœ¬ç®¡ç†
    - å¯åŠ¨æ—¶åŠ è½½è„šæœ¬å¹¶ç¼“å­˜ SHAã€‚
    - è„šæœ¬ç‰ˆæœ¬å·ä¸æœåŠ¡ç‰ˆæœ¬ç»‘å®šï¼ˆä¾¿äºç°åº¦å’Œå›æ»šï¼‰ã€‚

2. å¤±è´¥ä¿æŠ¤
    - `NOSCRIPT` è‡ªåŠ¨å›é€€ EVAL + é‡æ–°ç¼“å­˜ SHAã€‚
    - Redis çŸ­æš‚å¼‚å¸¸æ—¶ï¼Œä¸šåŠ¡å±‚é™çº§ä¸º RetryableFailureï¼Œä¸åšæœ¬åœ°è¡¥å¿å†™ã€‚

3. å¯è§‚æµ‹æ€§
    - æ¯ä¸ªè„šæœ¬ç»Ÿè®¡ `latency_ms / code_count / redis_error_count`ã€‚
    - å¯¹ `FENCING_REJECT / CAS_CONFLICT / OUT_OF_ORDER` å»ºç«‹å‘Šè­¦é˜ˆå€¼ã€‚

è¯¥ Lua-first æ–¹æ¡ˆå¯å°† ParserTaskModel ä¸ ErrorTaskModel çš„é«˜é¢‘ Redis äº¤äº’ç»Ÿä¸€ä¸ºå¯å®¡è®¡ã€å¯å›æ”¾ã€å¯è¯æ˜åŸå­æ€§çš„çŠ¶æ€è¿ç§»æ¨¡å‹ï¼Œæ˜¾è‘—é™ä½åˆ†å¸ƒå¼ç«æ€å¯¼è‡´çš„ä¸ä¸€è‡´é£é™©ã€‚

---

## 17. å•èŠ‚ç‚¹è¿è¡Œæ¨¡å¼è®¾è®¡ï¼ˆDashMap æ›¿ä»£ Redisï¼‰

> ç›®æ ‡ï¼šå½“ç³»ç»Ÿä»¥å•èŠ‚ç‚¹è¿è¡Œæ—¶ï¼Œå…è®¸ä½¿ç”¨å†…å­˜ DashMap æ›¿ä»£ Redisï¼ŒåŒæ—¶ä¿è¯ä¸åˆ†å¸ƒå¼æ¨¡å¼å°½é‡ä¸€è‡´çš„ä¸šåŠ¡è¯­ä¹‰ã€‚

### 17.1 æ¨¡å¼å®šä¹‰

è¿è¡Œæ¨¡å¼ç”±é…ç½®è‡ªåŠ¨åˆ¤å®šï¼ˆæ— éœ€æ‰‹å·¥å¼€å…³ï¼‰ï¼š

è¯­ä¹‰ï¼š

- å½“ `cache.redis` å·²é…ç½®ï¼š`distributed`ï¼ˆä½¿ç”¨ Redis + Lua è„šæœ¬ï¼‰ã€‚
- å½“ `cache.redis` æœªé…ç½®ï¼š`single_node`ï¼ˆä½¿ç”¨è¿›ç¨‹å†…çŠ¶æ€å­˜å‚¨ï¼ŒDashMap + åŸå­åŸè¯­ï¼‰ã€‚

### 17.2 ä½¿ç”¨ CacheService ç»Ÿä¸€ç®¡ç†ï¼ˆå…³é”®ï¼‰

ä¸æ–°å¢é¢å¤–æŠ½è±¡å±‚ï¼Œç»Ÿä¸€åŸºäº `CacheService` ç®¡ç†çŠ¶æ€ï¼š

- åˆ†å¸ƒå¼æ¨¡å¼ï¼š`CacheService` åç«¯ä¸º Redisï¼Œå…³é”®è·¯å¾„é€šè¿‡ Lua è„šæœ¬ï¼ˆ`EVALSHA`ï¼‰æ‰§è¡Œã€‚
- å•èŠ‚ç‚¹æ¨¡å¼ï¼š`CacheService` åç«¯ä¸ºè¿›ç¨‹å†… DashMapï¼Œæä¾›ä¸ Lua å¯¹é½çš„åŸå­çŠ¶æ€è¿ç§»æ–¹æ³•ã€‚

- ä¸šåŠ¡å±‚ä»…è°ƒç”¨ `CacheService` / `CacheAble`ï¼Œä¸ç›´æ¥åŒºåˆ† Redis/DashMapã€‚

ä¼˜å…ˆå¤ç”¨å·²æœ‰é€šç”¨èƒ½åŠ›ï¼ˆé¿å…ä¸º task_model å®šåˆ¶è¿‡å¤šæ–°æ¥å£ï¼‰ï¼š

- `CacheAble::send / sync / send_nx / delete / scan`
- `CacheService::set / get / del / set_nx / incr / mget`
- `CacheService::zadd / zrangebyscore / zremrangebyscore`

ä»…åœ¨ç¡®æœ‰å¿…è¦æ—¶ï¼Œå¯¹ `CacheService` åš**æœ€å°å¢é‡**æ‰©å±•ï¼ˆä¾‹å¦‚ `eval_lua/evalsha`ï¼‰ï¼Œä¸æ–°å¢ task_model ä¸“å±æŠ½è±¡å±‚ã€‚

### 17.3 å•èŠ‚ç‚¹æ¨¡å¼ç®€åŒ–åŸåˆ™ï¼ˆä¸æ¨¡æ‹Ÿ Luaï¼‰

å•èŠ‚ç‚¹æ¨¡å¼ä¸‹ä¸å¼•å…¥ Lua è„šæœ¬è¯­ä¹‰æ¨¡æ‹Ÿï¼Œé‡‡ç”¨â€œæœ€å°å¯ç”¨â€çš„æœ¬åœ°ç¼“å­˜è¡Œä¸ºï¼š

1. **èŒè´£æœ€å°åŒ–**ï¼š`LocalBackend` ä»…æä¾› `get/set/del/set_nx/incr/mget/zset` ç­‰åŸºç¡€èƒ½åŠ›ã€‚
2. **ä¸åšåˆ†å¸ƒå¼é˜²æŠ¤**ï¼šä¸åœ¨ `LocalBackend` å®ç° claim/commit/fencing/CAS ç­‰åˆ†å¸ƒå¼çŠ¶æ€æœºé€»è¾‘ã€‚
3. **è„šæœ¬èƒ½åŠ›ä»…åˆ†å¸ƒå¼å¯ç”¨**ï¼š`script_load/evalsha/eval_lua` åªåœ¨ Redis åç«¯å¯ç”¨ï¼›å•èŠ‚ç‚¹ä¸‹æ˜ç¡®è¿”å›ä¸æ”¯æŒã€‚

çº¦æŸï¼šä¸šåŠ¡å±‚æŒ‰è‡ªåŠ¨åˆ¤å®šè·¯å¾„é€‰æ‹©ï¼Œ`single_node` è·³è¿‡ Lua é“¾è·¯ï¼Œ`distributed` ç»§ç»­èµ° Lua-first åŸå­è„šæœ¬ã€‚

### 17.4 DashMap æ•°æ®ç»“æ„å»ºè®®

å¯æŒ‰ä»¥ä¸‹ç»“æ„ç»„ç»‡ï¼ˆç¤ºæ„ï¼‰ï¼š

1. `exec_state_map: DashMap<ExecKey, ExecState>`
   - `committed_step`, `inflight_step`, `version`, `lease_expire_at`
2. `ptm_dedup_map: DashMap<PtmKey, DedupState>`
   - `pending | processing | done | failed`
3. `error_threshold_map: DashMap<ThresholdKey, CounterState>`
   - `module_error_count`, `task_error_count`, `last_decision`
4. `retry_schedule_map: BTreeMap<Timestamp, Vec<RetryItem>>`
   - æ¨¡æ‹Ÿå»¶è¿Ÿé˜Ÿåˆ—
5. `gate_map: HashSet<GateKey>`
   - `advance/fallback` ä¸€æ¬¡æ€§é—¨é—¸

### 17.5 TTL ä¸è¿‡æœŸæœºåˆ¶

Redis æ¨¡å¼å¤©ç„¶æ”¯æŒ TTLï¼›å•èŠ‚ç‚¹å¿…é¡»æ˜¾å¼æ¨¡æ‹Ÿï¼š

1. æ¯æ¡è®°å½•å†™å…¥ `expires_at`ã€‚
2. æä¾›åå°æ¸…ç†åç¨‹ï¼ˆå®šæ—¶æ‰«è¿‡æœŸé”®ï¼‰ã€‚
3. å…³é”®è·¯å¾„è¯»å–æ—¶æƒ°æ€§æ¸…ç†ï¼ˆè¯»åˆ°è¿‡æœŸç«‹å³åˆ é™¤ï¼‰ã€‚

çº¦æŸï¼š

- è¿‡æœŸç­–ç•¥ä¸ Redis TTL å°½é‡ä¸€è‡´ã€‚
- æµ‹è¯•ç¯å¢ƒå¯ç¼©çŸ­ TTL æé«˜éªŒè¯é€Ÿåº¦ã€‚

### 17.6 é”ä¸ fencing åœ¨å•èŠ‚ç‚¹çš„å¤„ç†

å•èŠ‚ç‚¹æ²¡æœ‰è·¨è¿›ç¨‹é”ç«äº‰ï¼Œä½†ä»å»ºè®®ä¿ç•™ fencing é€»è¾‘ï¼š

1. æ¯æ¬¡ claim ä»è‡ªå¢ `version`ã€‚
2. commit æ—¶ä»æ ¡éªŒ `version`ã€‚
3. è‹¥ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œè¿”å› `FENCING_REJECT`ã€‚

æ”¶ç›Šï¼š

- å•èŠ‚ç‚¹è¡Œä¸ºä¸åˆ†å¸ƒå¼è¡Œä¸ºä¸€è‡´ã€‚
- ä¾¿äºå°†å•èŠ‚ç‚¹æµ‹è¯•ç»“æœç›´æ¥æ˜ å°„åˆ°ç”Ÿäº§æ¨¡å¼ã€‚

### 17.7 ErrorTaskModel ä¸ ParserTaskModel åœ¨å•èŠ‚ç‚¹æ¨¡å¼çš„è¦æ±‚

1. **ParserTaskModel**
   - å¿…é¡»ä»èµ° `claim -> execute -> commit_success/commit_error` ä¸‰æ®µè¯­ä¹‰ã€‚
   - å…è®¸æ¶ˆæ¯é‡å¤è¿›å…¥ï¼Œä½† dedup å¿…é¡»æ‹¦æˆªé‡å¤å‰¯ä½œç”¨ã€‚

2. **ErrorTaskModel**
   - å¿…é¡»ä»èµ° `threshold_decide -> retry/terminate` åŸå­æµç¨‹ã€‚
   - æ¨¡å—çº§/ä»»åŠ¡çº§è®¡æ•°å¿…é¡»ä¸åˆ†å¸ƒå¼æ¨¡å¼ä¸€è‡´ã€‚

### 17.8 é˜Ÿåˆ—ä¸è°ƒåº¦é€‚é…

å•èŠ‚ç‚¹å»ºè®®ä¿ç•™é˜Ÿåˆ—æŠ½è±¡ï¼š

- å¯ä½¿ç”¨å†…å­˜ channel æ›¿ä»£å¤–éƒ¨é˜Ÿåˆ—ã€‚
- å»¶è¿Ÿé‡è¯•ä½¿ç”¨æœ¬åœ°æ—¶é—´è½®æˆ– `BTreeMap + tick`ã€‚
- ä»ä¿ç•™ ack/retry æ¦‚å¿µï¼Œé¿å…ä¸¤ç§è¿è¡Œæ¨¡å¼é€»è¾‘åˆ†å‰ã€‚

### 17.9 å¯è§‚æµ‹æ€§ä¸€è‡´æ€§

å•èŠ‚ç‚¹æ¨¡å¼ä¹Ÿå¿…é¡»è¾“å‡ºä¸åˆ†å¸ƒå¼ç›¸åŒçš„å…³é”®æŒ‡æ ‡ï¼š

- `ptm_claim_total`
- `ptm_commit_total`
- `error_task_retry_total`
- `error_task_terminated_total`
- `state_expired_total`

å¹¶åœ¨æ—¥å¿—ä¸­æ ‡æ³¨ï¼š`runtime_mode=single_node`ã€‚

### 17.10 é™çº§è¾¹ç•Œä¸æ³¨æ„äº‹é¡¹

å•èŠ‚ç‚¹ DashMap æ¨¡å¼ä»…ç”¨äºï¼š

- æœ¬åœ°å¼€å‘
- å•æœºå‹æµ‹
- CI å¿«é€Ÿå›å½’

ä¸å»ºè®®ç”¨äºï¼š

- å¤šè¿›ç¨‹éƒ¨ç½²
- å¤šå®ä¾‹å®¹å™¨éƒ¨ç½²
- éœ€è¦è·¨èŠ‚ç‚¹ä¸€è‡´æ€§çš„ç”Ÿäº§ç¯å¢ƒ

å½“æ£€æµ‹åˆ°å¤šå®ä¾‹è¿è¡Œï¼ˆä¾‹å¦‚åŒ run_id å¤šè¿›ç¨‹ï¼‰æ—¶ï¼Œå»ºè®®å¼ºåˆ¶åˆ‡æ¢ Redis æ¨¡å¼æˆ–ç›´æ¥æ‹’ç»å¯åŠ¨ã€‚

### 17.11 å®æ–½å»ºè®®

1. å…ˆç”¨ `CacheService` ç°æœ‰é€šç”¨æ¥å£å®Œæˆç¬¬ä¸€ç‰ˆï¼ˆ`set_nx/incr/zset/mget` + `CacheAble`ï¼‰ã€‚
2. Redis åç«¯å…³é”®åŸå­è·¯å¾„é€šè¿‡ Luaï¼ˆç”Ÿäº§ï¼‰ï¼Œè„šæœ¬æ‰§è¡Œå…¥å£ä»æŒ‚åœ¨ `CacheService`ã€‚
3. DashMap åç«¯æŒ‰åŒä¸€çŠ¶æ€æœºè¯­ä¹‰å®ç°ï¼Œä¿æŒè¿”å›ç ä¸€è‡´ã€‚
4. å¢åŠ â€œåç«¯ä¸€è‡´æ€§æµ‹è¯•â€ï¼šåŒè¾“å…¥åœ¨ Redis ä¸ DashMap ä¸‹æœ€ç»ˆçŠ¶æ€ä¸€è‡´ã€‚
5. çº¦æŸï¼šé™¤ `CacheService` æœ€å°æ‰©å±•å¤–ï¼Œä¸å¢åŠ  task_model ä¸“å±ç¼“å­˜æ¥å£ã€‚

é€šè¿‡è¯¥è®¾è®¡ï¼Œå¯ä»¥åœ¨ä¸æ”¹å˜ä¸»ä¸šåŠ¡ç¼–æ’çš„å‰æä¸‹ï¼Œè®©å•èŠ‚ç‚¹ä¸åˆ†å¸ƒå¼å…±äº«åŒä¸€çŠ¶æ€æœºä¸å¹‚ç­‰è¯­ä¹‰ï¼Œé™ä½å¼€å‘è°ƒè¯•æˆæœ¬å¹¶æå‡çº¿ä¸Šå¯é¢„æµ‹æ€§ã€‚

---

## 18. ToListï¼ˆè„šæ‰‹æ¶ä¼˜å…ˆã€å¯ç›´æ¥æ’æœŸï¼‰

> è¯´æ˜ï¼šä»¥ä¸‹ä»»åŠ¡æŒ‰â€œå…ˆè„šæ‰‹æ¶ã€å†æ ¸å¿ƒçŠ¶æ€æœºã€åç°åº¦æ”¶æ•›â€æ’åºã€‚æ¯ä¸ªä»»åŠ¡å‡åŒ…å«ï¼šä»»åŠ¡ç›®æ ‡ã€è½åœ°æ–¹æ¡ˆã€äº¤ä»˜æ¸…å•ã€éªŒæ”¶æ ‡å‡†ã€æµ‹è¯•ç”¨ä¾‹ã€‚

### T01 é…ç½®ä¸è¿è¡Œæ¨¡å¼è„šæ‰‹æ¶

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆ

- ä»»åŠ¡ç›®æ ‡
   - å»ºç«‹ç»Ÿä¸€åˆ¤å®šè§„åˆ™ï¼šæ ¹æ® `cache.redis` è‡ªåŠ¨è¯†åˆ« `distributed|single_node`ï¼Œå¹¶è¡¥é½å¹¶å‘é…ç½®å…¥å£ï¼ˆ`task_concurrency`ã€`publish_concurrency`ã€`parser_concurrency`ã€`error_task_concurrency`ï¼‰ã€‚
- è½åœ°æ–¹æ¡ˆ
   - åœ¨ `common/config` å¢åŠ é…ç½®ç»“æ„ä¸é»˜è®¤å€¼ã€‚
   - åœ¨å¼•å¯¼æµç¨‹ç»Ÿä¸€åŠ è½½é…ç½®ï¼Œæ³¨å…¥é“¾è·¯æ„å»ºå™¨ä¸ `CacheService` åˆå§‹åŒ–ã€‚
   - å¢åŠ æ¨¡å¼åˆ¤å®šæ—¥å¿—ä¸ä¿æŠ¤ï¼ˆç¼ºå°‘ `cache.redis` æ—¶è¿›å…¥å•èŠ‚ç‚¹ï¼‰ã€‚
- äº¤ä»˜æ¸…å•
   - é…ç½®ç»“æ„ä½“ä¸è§£æé€»è¾‘ã€‚
   - ç¤ºä¾‹é…ç½®ï¼ˆæµ‹è¯•/ç”Ÿäº§æ ·ä¾‹ï¼‰ã€‚
   - å¯åŠ¨æ—¥å¿—è¾“å‡º `runtime_mode` ä¸å…³é”®å¹¶å‘å‚æ•°ã€‚
- éªŒæ”¶æ ‡å‡†
   - ä¸æ”¹ä¸šåŠ¡ä»£ç å³å¯é€šè¿‡é…ç½®åˆ‡æ¢ Redis/DashMap åç«¯ã€‚
   - ç¼ºçœé…ç½®å¯å¯åŠ¨ï¼Œä¸”å‚æ•°è½ç›˜æ—¥å¿—å¯è§ã€‚
- æµ‹è¯•ç”¨ä¾‹
   - é…ç½®åŠ è½½å•æµ‹ï¼šé»˜è®¤å€¼ã€ç¼ºå¤±å­—æ®µã€éæ³•å€¼ã€‚
   - å¯åŠ¨é›†æˆæµ‹ï¼šä¸¤ç§æ¨¡å¼å‡å¯å®Œæˆåˆå§‹åŒ–ã€‚

### T02 UnifiedTaskInput ä¸ç»Ÿä¸€å…¥å£å·¥å‚

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆ

- ä»»åŠ¡ç›®æ ‡
   - å°† TaskModel / ParserTaskModel / ErrorTaskModel ç»Ÿä¸€æ”¶å£åˆ°å•å…¥å£ï¼ˆTask Ingress Chainï¼‰ã€‚
- è½åœ°æ–¹æ¡ˆ
   - æ–°å¢ `UnifiedTaskInput` æšä¸¾ä¸å½’ä¸€åŒ–å™¨ã€‚
   - æ–°å¢ç»Ÿä¸€å·¥å‚ `task_model_chain`ï¼Œå¹¶ä¿ç•™æ—§é“¾è·¯å…¼å®¹å£³ã€‚
   - å…¥å£é˜¶æ®µå›ºå®šä¸ºï¼šNormalizeInput -> LoadTask -> ThresholdPreCheck -> BuildModules -> ModuleDispatchã€‚
- äº¤ä»˜æ¸…å•
   - è¾“å…¥å½’ä¸€åŒ–æ¨¡å—ã€‚
   - ç»Ÿä¸€å…¥å£é“¾å·¥å‚å®ç°ã€‚
   - æ—§é“¾è·¯å…¼å®¹è½¬å‘é€»è¾‘ä¸å¼€å…³ã€‚
- éªŒæ”¶æ ‡å‡†
   - ä¸‰ç±»è¾“å…¥å‡è¿›å…¥åŒä¸€å…¥å£é“¾å¹¶æ‰“ç»Ÿä¸€æ—¥å¿—å­—æ®µã€‚
   - å…¼å®¹æ¨¡å¼ä¸‹å¯æŒ‰å¼€å…³åˆ‡å›æ—§é“¾è·¯ã€‚
- æµ‹è¯•ç”¨ä¾‹
   - ä¸‰ç±»è¾“å…¥å½’ä¸€åŒ–å•æµ‹ã€‚
   - å…¥å£é˜¶æ®µé¡ºåºä¸å¤±è´¥è¯­ä¹‰é›†æˆæµ‹ã€‚

### T03 ä»»åŠ¡çº§é¢„æ£€ä¸å†³ç­–è¯­ä¹‰è„šæ‰‹æ¶

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆ

- ä»»åŠ¡ç›®æ ‡
   - å›ºåŒ– Continue / RetryAfter / Terminate(module) / Terminate(task) ç»Ÿä¸€å†³ç­–è¯­ä¹‰ã€‚
- è½åœ°æ–¹æ¡ˆ
   - æ–°å¢ `ChainDecisionRouter` ä¸ `ThresholdDecisionService` æ¥å£ã€‚
   - å…¥å£é“¾ä»…åšä»»åŠ¡çº§å¿«é€Ÿé¢„æ£€ï¼›ä¸¥æ ¼åŒé˜ˆå€¼ç•™åœ¨ ErrorTask æ¶ˆè´¹é“¾ã€‚
   - ç¦æ­¢å…³é”®æ­¥éª¤é™é»˜ Skipï¼ˆLoadTask/BuildModulesï¼‰ã€‚
- äº¤ä»˜æ¸…å•
   - å†³ç­–æšä¸¾ã€é”™è¯¯åˆ†ç±»æ˜ å°„ã€å…¬å…±è¿”å›ç ã€‚
   - å…¥å£é¢„æ£€å®ç°ä¸å¯è§‚æµ‹åŸ‹ç‚¹ã€‚
- éªŒæ”¶æ ‡å‡†
   - æ‰€æœ‰é“¾è·¯è¿”å›ç»Ÿä¸€å†³ç­–ç±»å‹ã€‚
   - å…³é”®æ­¥éª¤å¤±è´¥å¯è§‚æµ‹ä¸”æœ‰æ˜ç¡®ç»ˆæ­¢åŸå› ã€‚
- æµ‹è¯•ç”¨ä¾‹
   - å†³ç­–æ˜ å°„å•æµ‹ï¼ˆå¯æ¢å¤/ä¸å¯æ¢å¤/å¯è·³è¿‡ï¼‰ã€‚
   - å…¥å£é¢„æ£€å‘½ä¸­ä¸æ”¾è¡Œé›†æˆæµ‹ã€‚

### T04 ModuleProcessorWithChain èŒè´£æ”¶æ•›

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆ
- è¿›åº¦ï¼šå·²å®Œæˆç¬¬ä¸€åˆ€å…¥å£å‡è´£ï¼š`TaskProcessor` ä»â€œç”Ÿæˆ+å»é‡+å‘å¸ƒâ€æ”¶æ•›ä¸ºâ€œä»…ç”Ÿæˆè¯·æ±‚æµâ€ï¼Œè¯·æ±‚å»é‡ä¸å‘å¸ƒç»Ÿä¸€ä¸‹æ²‰åˆ° `RequestPublish`ï¼›`Module.generate/execute_request` ç»§ç»­ä½œä¸º step è¯­ä¹‰å…¥å£ã€‚å¹¶é€šè¿‡ `cargo check` ä¸ `cargo test`ï¼ˆ13/13ï¼‰ã€‚
- è¿›åº¦ï¼šå·²å®Œæˆç¬¬äºŒåˆ€å…¥å£è¾¹ç•Œæ”¶æ•›ï¼š`task_meta/login_info` ä¸å†ç» `ProcessorContext.metadata` é€ä¼ ï¼Œæ”¹ä¸ºåœ¨ `TaskModuleProcessor` ç»Ÿä¸€ç»‘å®šåˆ° `Module`ï¼ˆ`bind_task_context`ï¼‰ï¼Œ`TaskProcessor` ä»…æ¶ˆè´¹æ¨¡å—å·²ç»‘å®šä¸Šä¸‹æ–‡å¹¶è§¦å‘ç”Ÿæˆã€‚
- è¿›åº¦ï¼šå·²å®Œæˆç¬¬ä¸‰åˆ€å…¥å£åˆ†æ”¯æ”¶æ•›ï¼š`TaskProcessor` ç§»é™¤ç™»å½•æ ¡éªŒåˆ†æ”¯ï¼Œç»Ÿä¸€å¤ç”¨ `Module.generate` çš„é”™è¯¯è¯­ä¹‰ï¼Œå…¥å£è¿›ä¸€æ­¥æ”¶æ•›ä¸ºâ€œç»ˆæ­¢æ£€æŸ¥ + ç”Ÿæˆè§¦å‘â€ã€‚
- è¿›åº¦ï¼šå·²å®Œæˆç¬¬å››åˆ€å…¥å£å»é‡ï¼šç§»é™¤ `TaskProcessor` çš„é‡å¤æ¨¡å—ç»ˆæ­¢é¢„æ£€ï¼ˆè¯¥é€»è¾‘ä¿ç•™åœ¨ `TaskModuleProcessor`ï¼‰ï¼Œ`TaskProcessor` è¿›ä¸€æ­¥æ”¶æ•›ä¸ºâ€œè¯»å–ç»‘å®šä¸Šä¸‹æ–‡å¹¶è§¦å‘ generateâ€ã€‚
- è¿›åº¦ï¼šå·²è¡¥é½ T04 æœ€å°è¾¹ç•Œå›å½’ï¼š`task::module` æ–°å¢ç»‘å®šä¸Šä¸‹æ–‡å›è¯»æµ‹è¯•ä¸â€œç™»å½•å¿…éœ€æ¨¡å—ç¼ºå¤±ç™»å½•ä¿¡æ¯â€é”™è¯¯è¯­ä¹‰æµ‹è¯•ï¼ŒéªŒè¯å…¥å£å‡è´£åæ ¸å¿ƒè¾¹ç•Œè¡Œä¸ºç¨³å®šã€‚
- è¿›åº¦ï¼šå·²ä¸ T05 è”è°ƒéªŒè¯ï¼šParser/Error é—­ç¯åˆ†æµç¨³å®šï¼Œå…¥å£é“¾ä¿æŒâ€œåˆ†å‘+ç”Ÿæˆè§¦å‘â€èŒè´£è¾¹ç•Œã€‚
- è¿›åº¦ï¼šå·²è¡¥é½å›é€€é—¨é—¸æç«¯åœºæ™¯å›å½’ï¼šåŒä¸€ `step_idx + prefix_request` é¦–æ¬¡å›é€€å¯æ¢å¤å‰ç½®è¯·æ±‚ï¼ŒäºŒæ¬¡å›é€€è¢«é—¨é—¸é˜»æ–­ï¼Œé¿å…æ— é™å›é€€å¾ªç¯ã€‚

- ä»»åŠ¡ç›®æ ‡
   - è®©æ¨¡å—å†… step æ¨è¿›/å›é€€/ç»ˆæ­¢å®Œå…¨ç”± `ModuleProcessorWithChain` è´Ÿè´£ã€‚
- è½åœ°æ–¹æ¡ˆ
   - ä¸‹æ²‰ step ä¸šåŠ¡å†³ç­–åˆ° `resolve_execution_context`ã€`execute_request_impl`ã€`execute_parser`ã€‚
   - å…¥å£é“¾ä»…ä¿ç•™åˆ†å‘ä¸å¹¶å‘æ§åˆ¶ï¼Œä¸åš step åˆ¤å®šã€‚
   - å›ºåŒ– `prefix_request` æŒä¹…åŒ–ä¸å›é€€æ¢å¤ã€‚
- äº¤ä»˜æ¸…å•
   - æ¨¡å—å¤„ç†å™¨ä¸»æµç¨‹é‡æ„ã€‚
   - å›é€€é—¨é—¸ä¸æ¨è¿›é—¨é—¸ç»Ÿä¸€è°ƒç”¨ç‚¹ã€‚
   - ä¸Šä¸‹æ–‡å­—æ®µå®Œæ•´æ€§æ ¡éªŒã€‚
- éªŒæ”¶æ ‡å‡†
   - éé¦– step ç”Ÿæˆå¤±è´¥å¯æŒ‰é—¨é—¸æ‰§è¡Œâ€œä¸€æ¬¡å›é€€â€ã€‚
   - æ— ä¸‹ä¸€ step æ—¶æ¨¡å—æ­£ç¡®ç»“æŸï¼Œä¸é‡å¤æ¨è¿›ã€‚
- æµ‹è¯•ç”¨ä¾‹
   - å¤š step æ­£å¸¸æ¨è¿›ç”¨ä¾‹ã€‚
   - ç”Ÿæˆå¤±è´¥å›é€€ä¸€æ¬¡ä¸é—¨é—¸é˜»æ–­ç”¨ä¾‹ã€‚

### T05 Parser/Error è‡ªåŠ¨äº§å‡ºé—­ç¯

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆ
- è¿›åº¦ï¼šå·²æ–°å¢ `ModuleProcessorWithChain::execute_parser` æœ€å°é—­ç¯å›å½’æµ‹è¯•ï¼šè¦†ç›–â€œè§£ææˆåŠŸæ¨è¿›ä¸‹ä¸€æ­¥å¹¶ä¿ç•™ prefix_requestâ€ä¸â€œè§£æå¤±è´¥äº§å‡º ErrorTaskModel ä¸” stay_current_step=true/module_id+step_idx å®Œæ•´â€ã€‚
- è¿›åº¦ï¼šå·²æ–°å¢äº‹ä»¶å±‚ä¸€è‡´æ€§å›å½’ï¼š`ParserTaskModelEvent` å¯¹ ParserTask/ErrorTask çš„å­—æ®µæ˜ å°„ä¸€è‡´ï¼Œä¸” `engine.parser_task_model.completed` äº‹ä»¶é”®å‘½åç¨³å®šã€‚
- è¿›åº¦ï¼šå·²å®Œæˆäº‹ä»¶è¯­ä¹‰å‘½åæ”¶å£åŸºçº¿ï¼šæ–°å¢ `ParserTaskProduced`ã€`ErrorTaskProduced`ã€`ModuleStepAdvanced`ã€`ModuleStepFallback` äº‹ä»¶ç±»å‹ä¸ç¨³å®šå‘½åæµ‹è¯•ã€‚
- è¿›åº¦ï¼šå·²åœ¨ `parser_chain` å®é™…åˆ†æµè·¯å¾„æ¥å…¥è¯­ä¹‰äº‹ä»¶å‘å°„ï¼šParserTask äº§å‡ºã€ErrorTask äº§å‡ºã€æœ¬åœ°æ¨è¿›æˆåŠŸä¸å›é€€åˆ†æ”¯å‡å¯å‘å°„å¯¹åº”è¯­ä¹‰äº‹ä»¶ã€‚
- è¿›åº¦ï¼šå·²è¡¥é½ EventBus è®¢é˜…ç«¯é›†æˆå›å½’ï¼šéªŒè¯ `engine.parser_task_produced.completed` äº‹ä»¶å¯è¢«è®¢é˜…å¹¶ç¨³å®šæŠ•é€’ã€‚

- ä»»åŠ¡ç›®æ ‡
   - è§£ææˆåŠŸè‡ªåŠ¨äº§å‡º ParserTaskModelï¼Œè§£æå¤±è´¥è‡ªåŠ¨äº§å‡º ErrorTaskModelï¼Œæ¶ˆé™¤æ‰‹å·¥åˆ†å‰ã€‚
- è½åœ°æ–¹æ¡ˆ
   - åœ¨ `execute_parser` ç»Ÿä¸€åˆ†æµï¼šæˆåŠŸæ¨è¿› / å¤±è´¥å…¥é”™é˜Ÿåˆ—ã€‚
   - ErrorTaskModel å¼ºåˆ¶ä¿ç•™ `context.step_idx`ã€`module_id`ã€`prefix_request` ä¸” `stay_current_step=true`ã€‚
   - ç»Ÿä¸€äº‹ä»¶è¯­ä¹‰ï¼šParserTaskProducedã€ErrorTaskProducedã€ModuleStepAdvancedã€ModuleStepFallbackã€‚
- äº¤ä»˜æ¸…å•
   - ParserData -> ä¸‹ä¸€åŠ¨ä½œè½¬æ¢å™¨ã€‚
   - ErrorTask ç”Ÿæˆå™¨ä¸å­—æ®µçº¦æŸæ ¡éªŒã€‚
   - äº‹ä»¶å‘å¸ƒé€‚é…ã€‚
- éªŒæ”¶æ ‡å‡†
   - è§£æå¤±è´¥ä¸ä¼šé™é»˜ä¸¢å¼ƒï¼Œå¿…æœ‰ ErrorTask è®°å½•ã€‚
   - è§£ææˆåŠŸæ—¶ step æ¨è¿›ä¸äº‹ä»¶è®°å½•ä¸€è‡´ã€‚
- æµ‹è¯•ç”¨ä¾‹
   - parser success/failure è·¯å¾„å•æµ‹ã€‚
   - äº‹ä»¶äº§å‡ºå®Œæ•´æ€§é›†æˆæµ‹ã€‚

### T06 å¹‚ç­‰é”®ä¸çŠ¶æ€é”®æ„é€ å™¨ï¼ˆKey Builderï¼‰

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆ
- è¿›åº¦ï¼šå·²å®Œæˆ `execution_state_key` ç³»åˆ—æ‰©å±•ï¼šæ–°å¢ legacy å…¼å®¹æ„é€ å™¨ï¼ˆ`legacy_execution_state_key`ï¼‰ä¸å…¼å®¹é”®é›†åˆï¼ˆ`execution_state_compat_keys`ï¼‰ï¼Œç»Ÿä¸€æ–°æ—§é”®å¹¶è¡Œè¯†åˆ«è¯­ä¹‰ã€‚
- è¿›åº¦ï¼šå·²å®Œæˆ step é—¨é—¸é”®æ„é€ å™¨æ”¶å£ï¼šæ–°å¢ `module_step_advance_once_key` / `module_step_fallback_once_key` åŠ legacy å¯¹åº”æ„é€ å™¨ï¼Œé¿å…ä¸šåŠ¡ä¾§å­—ç¬¦ä¸²æ‰‹æ‹¼æ¼‚ç§»ã€‚
- è¿›åº¦ï¼šå·²å®Œæˆ `ModuleProcessorWithChain` å…¨é“¾è·¯è¿ç§»ä¸å…¼å®¹è¯»å†™ï¼šæ¨è¿›é—¨é—¸ã€å›é€€é—¨é—¸ã€stop æ ‡è®°å‡æ”¯æŒâ€œå…ˆè¯»æ–°é”®ã€å†è¯»æ—§é”®ï¼›å†™å…¥åŒé”®â€ç­–ç•¥ã€‚
- è¿›åº¦ï¼šå·²è¡¥é½å¹¶é€šè¿‡å›å½’éªŒè¯ï¼š`cargo test execution_state_compat_keys_include_new_and_legacy`ã€`cargo test module_step_gate_keys_are_stable_and_legacy_compatible`ã€`cargo test execute_parser_success_advances_to_next_step_and_keeps_prefix`ã€`cargo test execute_parser_failure_emits_error_task_with_stay_current_step`ã€‚

- ä»»åŠ¡ç›®æ ‡
   - ç»Ÿä¸€ `ptm_key` ä¸æ‰€æœ‰ Redis/DashMap çŠ¶æ€é”®ï¼Œé¿å…è·¨æ¨¡å—æ¼‚ç§»ã€‚
- è½åœ°æ–¹æ¡ˆ
   - æ–°å¢å…¬å…± key builderï¼š`chain:exec:*`ã€`chain:ptm:*`ã€`chain:gate:*`ã€`chain:error:*`ã€`chain:threshold:*`ã€`chain:terminate:*`ã€‚
   - å›ºåŒ– `ptm_key = hash(run_id + account + platform + module_id + step_idx + prefix_request)`ã€‚
   - å…¨é“¾è·¯æ”¹ä¸ºè°ƒç”¨ builderï¼Œç¦ç”¨å­—ç¬¦ä¸²æ‰‹æ‹¼ã€‚
- äº¤ä»˜æ¸…å•
   - é”®æ„é€ æ¨¡å—ä¸è§„èŒƒæ–‡æ¡£ã€‚
   - è¿ç§»ä¿®æ”¹åˆ—è¡¨ï¼ˆæ—§é”®åˆ°æ–°é”®ï¼‰ã€‚
- éªŒæ”¶æ ‡å‡†
   - åŒè¾“å…¥åœ¨ä»»æ„èŠ‚ç‚¹ç”Ÿæˆå®Œå…¨ä¸€è‡´é”®ã€‚
   - æ— ç›´æ¥å­—ç¬¦ä¸²æ‹¼ key çš„æ–°ä»£ç ã€‚
- æµ‹è¯•ç”¨ä¾‹
   - é”®ç¨³å®šæ€§å¿«ç…§æµ‹è¯•ã€‚
   - æ—§é”®å…¼å®¹è¯»å†™å›å½’æµ‹è¯•ã€‚

### T07 Lua-first åŸå­è„šæœ¬éª¨æ¶ï¼ˆRedis åç«¯ï¼‰

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆ
- è¿›åº¦ï¼šå·²è¡¥é½ PTM è„šæœ¬è¿”å›ç è¾¹ç•Œè¦†ç›–ï¼š`ptm_claim.lua` æ ¡éªŒ `EXECUTE/DUPLICATE_DONE/STALE_STEP/OUT_OF_ORDER/LOCKED_BY_OTHER`ï¼Œ`ptm_commit_success.lua` ä¸ `ptm_commit_error.lua` æ ¡éªŒ fencing/CAS/é‡å¤æäº¤è¯­ä¹‰ã€‚
- è¿›åº¦ï¼šå·²è¡¥é½ Redis é›†æˆçŠ¶æ€æœºå›å½’ï¼šæ–°å¢ `redis_ptm_claim_and_commit_success_follow_expected_state_machine`ï¼Œè¦†ç›– claim->commit->duplicate claim ä¸»é“¾è·¯ï¼Œä¸”æ—  Redis ç¯å¢ƒè‡ªåŠ¨è·³è¿‡ã€‚
- è¿›åº¦ï¼šå·²å®Œæˆå®šå‘éªŒè¯ï¼š`cargo test ptm_claim_contains_step_and_state_guards` ä¸ `cargo test redis_ptm_claim_and_commit_success_follow_expected_state_machine` é€šè¿‡ã€‚

- ä»»åŠ¡ç›®æ ‡
   - å°†å…³é”®çŠ¶æ€è¿ç§»æ”¹ä¸ºå•è„šæœ¬åŸå­æ‰§è¡Œï¼Œæ¶ˆé™¤ GET/SET ç«æ€ã€‚
- è½åœ°æ–¹æ¡ˆ
   - é¦–æ‰¹ä¸Šçº¿ï¼š`ptm_claim.lua`ã€`ptm_commit_success.lua`ã€`ptm_commit_error.lua`ã€`etm_threshold_decide.lua`ã€‚
   - å¯åŠ¨é¢„çƒ­ `EVALSHA`ï¼Œå¹¶å®ç° `NOSCRIPT` è‡ªåŠ¨å›é€€ã€‚
   - è„šæœ¬ç»Ÿä¸€è¿”å› `{code,msg,payload_json}`ã€‚
- äº¤ä»˜æ¸…å•
   - Lua è„šæœ¬ç›®å½•ä¸ç‰ˆæœ¬ç®¡ç†ã€‚
   - `CacheService` æœ€å°æ‰©å±•ï¼ˆ`evalsha/eval_lua`ï¼‰ã€‚
   - Rust ä¾§è¿”å›ç æ˜ å°„ä¸é”™è¯¯å¤„ç†ã€‚
- éªŒæ”¶æ ‡å‡†
   - å…³é”®è·¯å¾„æ— å¤šæ¬¡ Redis å¾€è¿”ç»„åˆåˆ¤å®šã€‚
   - å¹¶å‘ä¸‹æ— é‡å¤æ¨è¿›ä¸é‡å¤é”™è¯¯äº§å‡ºã€‚
- æµ‹è¯•ç”¨ä¾‹
   - è„šæœ¬å•æµ‹ï¼ˆè¿”å›ç è¦†ç›–ï¼‰ã€‚
   - å‹æµ‹å¹¶å‘å†²çªç”¨ä¾‹ï¼ˆCAS/Fencing/é‡å¤æ¶ˆæ¯ï¼‰ã€‚

### T08 DashMap å•èŠ‚ç‚¹åç«¯å¯¹é½å®ç°

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆ
- è¿›åº¦ï¼šå·²å®Œæˆ LocalBackend ç²¾ç®€ï¼ˆç§»é™¤æœ¬åœ° Lua æ¨¡æ‹Ÿï¼‰ä¸å•èŠ‚ç‚¹åŸºç¡€å›å½’æµ‹è¯•ï¼ˆKV/TTL/set_nx/zset/è„šæœ¬æ¥å£ä¸æ”¯æŒï¼‰ã€‚
- è¿›åº¦ï¼šå·²è¡¥é½ Redis vs single_node ä¸€è‡´æ€§å¯¹ç…§æµ‹è¯•ï¼šæ–°å¢ `redis_and_single_node_set_get_behave_consistently`ï¼Œè¦†ç›–åŒé”®å†™å…¥/è¦†ç›–åçš„è¯»å–ä¸€è‡´æ€§ä¸æ¸…ç†ã€‚
- è¿›åº¦ï¼šå·²å®Œæˆå®šå‘éªŒè¯ï¼š`cargo test redis_and_single_node_set_get_behave_consistently` é€šè¿‡ï¼ˆæ—  Redis ç¯å¢ƒè‡ªåŠ¨è·³è¿‡ï¼‰ã€‚

- ä»»åŠ¡ç›®æ ‡
   - åœ¨å•èŠ‚ç‚¹æ¨¡å¼æä¾›è½»é‡æœ¬åœ°ç¼“å­˜åç«¯ï¼Œé¿å…ä¸ºåˆ†å¸ƒå¼è¯­ä¹‰å¼•å…¥é¢å¤–å¤æ‚åº¦ã€‚
- è½åœ°æ–¹æ¡ˆ
   - `LocalBackend` ä»…ä¿ç•™åŸºç¡€ KV/ZSet èƒ½åŠ›ä¸ TTL æƒ°æ€§æ¸…ç†ã€‚
   - å•èŠ‚ç‚¹æ¶ˆè´¹é“¾è·¯ç›´æ¥æ‰§è¡Œæœ¬åœ°é€»è¾‘ï¼Œä¸èµ° Lua claim/commitã€‚
   - åˆ†å¸ƒå¼æ¨¡å¼ç»§ç»­ä½¿ç”¨ Redis + Luaï¼Œä¸åœ¨æœ¬åœ°åç«¯å¤åˆ»åˆ†å¸ƒå¼çŠ¶æ€æœºã€‚
- äº¤ä»˜æ¸…å•
   - ç²¾ç®€åçš„ LocalBackendï¼ˆæ— æœ¬åœ° Lua æ¨¡æ‹Ÿï¼‰ã€‚
   - å•èŠ‚ç‚¹/åˆ†å¸ƒå¼è·¯å¾„åˆ‡æ¢è¯´æ˜ã€‚
   - è¿‡æœŸæ¸…ç†ä¸åŸºç¡€æŒ‡æ ‡ã€‚
- éªŒæ”¶æ ‡å‡†
   - å•èŠ‚ç‚¹æ¨¡å¼ä¸‹é“¾è·¯å¯ç¨³å®šè¿è¡Œä¸”æ—  Lua ä¾èµ–ã€‚
   - åˆ†å¸ƒå¼æ¨¡å¼ä¸‹ Lua è„šæœ¬è·¯å¾„è¡Œä¸ºä¸å—å½±å“ã€‚
- æµ‹è¯•ç”¨ä¾‹
   - å•èŠ‚ç‚¹æ¨¡å¼åŸºç¡€ç¼“å­˜è¡Œä¸ºæµ‹è¯•ï¼ˆè¯»å†™ã€TTLã€set_nxã€zsetï¼‰ã€‚
   - åˆ†å¸ƒå¼æ¨¡å¼ Lua å›å½’æµ‹è¯•ã€‚

### T09 ErrorTask åŒé˜ˆå€¼ä¸¥æ ¼å†³ç­–é“¾

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆ
- è¿›åº¦ï¼šå·²æ¥å…¥ `threshold_decide -> retry_schedule/terminate_mark` Lua åŸå­åŠ¨ä½œé“¾ï¼Œè¡¥å……é‡è¯•è°ƒåº¦ä¸ç»ˆæ­¢æ ‡è®°è„šæœ¬å¹¶å®Œæˆç¼–è¯‘éªŒè¯ã€‚
- è¿›åº¦ï¼šå·²è¡¥å……é Lua åˆ†æ”¯ï¼ˆsingle_node/å›é€€è·¯å¾„ï¼‰ä¸‹çš„é‡è¯•è°ƒåº¦ zset è½ç›˜ä¸ç»ˆæ­¢æ ‡è®°å†™å…¥ï¼Œé¿å…åŠ¨ä½œè¯­ä¹‰ä»…åœ¨åˆ†å¸ƒå¼è„šæœ¬è·¯å¾„ç”Ÿæ•ˆã€‚
- è¿›åº¦ï¼šå·²è¡¥å…… `TaskTerminatedByThreshold` äº‹ä»¶è¾“å‡ºï¼ˆæ¨¡å—ç»ˆæ­¢/ä»»åŠ¡ç»ˆæ­¢ï¼‰ï¼Œç”¨äºé˜ˆå€¼æ²»ç†å®¡è®¡ä¸å‘Šè­¦è”åŠ¨ã€‚
- è¿›åº¦ï¼šå·²è¡¥å……æœ€å°å•æµ‹è¦†ç›–ï¼ˆLua è„šæœ¬æ³¨å†Œå®Œæ•´æ€§ã€`TaskTerminatedByThreshold` äº‹ä»¶ç±»å‹æ˜ å°„ï¼‰ï¼Œå¹¶é€šè¿‡å®šå‘æµ‹è¯•ä¸ç¼–è¯‘éªŒè¯ã€‚
- è¿›åº¦ï¼šå·²æ”¶æ•›å†³ç­–è¯­ä¹‰ï¼ˆæ ‡è®°åŠ¨ä½œæ˜¯å¦å·²æ‰§è¡Œï¼‰ï¼Œé¿å… Lua è·¯å¾„ä¸é Lua å›é€€è·¯å¾„é‡å¤å†™å…¥é‡è¯•è°ƒåº¦/ç»ˆæ­¢æ ‡è®°ã€‚
- è¿›åº¦ï¼šå·²æ–°å¢ `ChainDecision::action_applied()` è¯­ä¹‰ç¨³å®šæ€§å•æµ‹ï¼Œå¹¶å®Œæˆ `cargo check` ä¸ `cargo test` å…¨é‡éªŒè¯ï¼ˆå½“å‰ 11/11 é€šè¿‡ï¼‰ã€‚
- è¿›åº¦ï¼šå·²æ–°å¢ Lua è¯­ä¹‰æŠ¤æ æµ‹è¯•ï¼šé˜ˆå€¼è¾¹ç•Œé‡‡ç”¨ `>=`ï¼ˆåŒ…å«è¾¹ç•Œå€¼ï¼‰ï¼Œç»ˆæ­¢è„šæœ¬å…·å¤‡ `EXISTS` å¹‚ç­‰é˜²é‡ä¸ `ALREADY_TERMINATED` è¿”å›è¯­ä¹‰ã€‚
- è¿›åº¦ï¼šå·²æ–°å¢ Redis é›†æˆå¹¶å‘æµ‹è¯•å…¥å£ï¼ˆç¯å¢ƒå˜é‡ `REDIS_URL` / `MOCRA_REDIS_TEST_URL`ï¼‰ï¼šè¦†ç›– `etm_threshold_decide` è¾¹ç•Œå‘½ä¸­ä¸ `etm_terminate_mark` å¹¶å‘å¹‚ç­‰ï¼ˆæ—  Redis ç¯å¢ƒè‡ªåŠ¨è·³è¿‡ï¼‰ã€‚
- è¿›åº¦ï¼šå·²æ¥å…¥ CI åˆåŒæµ‹è¯•è„šæœ¬å¯é€‰é—¨ç¦ï¼ˆ`scripts/ci_contract_tests.ps1` / `scripts/ci_contract_tests.sh`ï¼‰ï¼Œåœ¨æœ‰ Redis åœ°å€æ—¶è‡ªåŠ¨æ‰§è¡Œ `cargo test redis_`ã€‚
- è¿›åº¦ï¼šå·²æ–°å¢ CI å¼ºåˆ¶é—¨ç¦å¼€å…³ `MOCRA_REQUIRE_REDIS_CONTRACT_TESTS=1`ï¼šå½“æœªæ³¨å…¥ `REDIS_URL`/`MOCRA_REDIS_TEST_URL` æ—¶ç›´æ¥å¤±è´¥ï¼Œæ”¯æŒé¢„å‘/CI ä»â€œå¯é€‰æ‰§è¡Œâ€å‡çº§ä¸ºâ€œå¿…é€‰æ‰§è¡Œâ€ã€‚
- è¿›åº¦ï¼šå·²ä¿®å¤ PowerShell åˆåŒè„šæœ¬é€€å‡ºç ä¼ æ’­ï¼š`scripts/ci_contract_tests.ps1` ç°å¯¹ `cargo test` å¤±è´¥ç«‹å³ä¸­æ–­å¹¶è¿”å›éé›¶ï¼Œé¿å…é—¨ç¦è¯¯æ”¾è¡Œã€‚

- ä»»åŠ¡ç›®æ ‡
   - å°†æ¨¡å—çº§ + ä»»åŠ¡çº§é˜ˆå€¼åˆ¤å®šå›ºå®šåˆ° ErrorTask æ¶ˆè´¹é“¾ï¼Œå¹¶åŸå­åŒ–ã€‚
- è½åœ°æ–¹æ¡ˆ
   - ErrorTask æ¶ˆè´¹æ—¶åºï¼š`threshold_decide -> retry_schedule æˆ– terminate_mark`ã€‚
   - æ¨¡å—çº§ä¼˜å…ˆï¼Œä»»åŠ¡çº§å…œåº•ã€‚
   - è¾“å‡ºå†³ç­–äº‹ä»¶ `TaskTerminatedByThreshold`ã€‚
- äº¤ä»˜æ¸…å•
   - åŒé˜ˆå€¼è„šæœ¬/å®ç°ã€‚
   - ç»ˆæ­¢æ ‡è®°ä¸é‡è¯•è°ƒåº¦å®ç°ã€‚
   - å†·å´ä¸é€€é¿å‚æ•°é…ç½®ã€‚
- éªŒæ”¶æ ‡å‡†
   - è¾¾æ¨¡å—é˜ˆå€¼ä»…ç»ˆæ­¢æ¨¡å—ï¼›è¾¾ä»»åŠ¡é˜ˆå€¼ç»ˆæ­¢ä»»åŠ¡ã€‚
   - åˆ¤å®šæ— ç«æ€ï¼Œè®¡æ•°ä¸åˆ†è£‚ã€‚
- æµ‹è¯•ç”¨ä¾‹
   - é˜ˆå€¼è¾¹ç•Œå€¼æµ‹è¯•ã€‚
   - é‡è¯•é€€é¿ä¸ç»ˆæ­¢å¹‚ç­‰æµ‹è¯•ã€‚

### T10 å¹¶å‘ä¸èƒŒå‹æ²»ç†

- çŠ¶æ€ï¼šğŸŸ¡ è¿›è¡Œä¸­ï¼ˆæš‚ç¼“ï¼‰
- è¿›åº¦ï¼šå·²å¯åŠ¨å‘å¸ƒè·¯å¾„èƒŒå‹æ²»ç†æœ€å°é—­ç¯ï¼šåœ¨ `RequestPublish` æ¥å…¥ `try_send -> await send` é™çº§ï¼Œæ–°å¢ `request_publish_backpressure_total{reason=queue_full|queue_closed}` æŒ‡æ ‡ä¸èƒŒå‹æ—¥å¿—ã€‚
- è¿›åº¦ï¼šå·²æ‰©å±•åˆ° `parser_chain` å…³é”®å‘é€è·¯å¾„ï¼ˆrequest/parser_task/errorï¼‰ï¼šç»Ÿä¸€ `try_send -> await send` é™çº§ï¼Œæ–°å¢ `parser_chain_backpressure_total{queue,reason}` æŒ‡æ ‡å¹¶ä¿ç•™åŸå¤±è´¥è¯­ä¹‰ã€‚
- è¿›åº¦ï¼šå·²æ‰©å±•åˆ° `download_chain` çš„ Response å‘å¸ƒè·¯å¾„ï¼šæœ¬åœ° response channel ä¸åå¤‡ response channel å‡æ¥å…¥ `queue_full/queue_closed` ç»†åˆ†æŒ‡æ ‡ä¸é™çº§å‘é€ã€‚
- è¿›åº¦ï¼šå·²å®ŒæˆèƒŒå‹é‡è¯•ç­–ç•¥å‚æ•°åŒ–ï¼šæ–°å¢ `crawler.backpressure_retry_delay_ms`ï¼Œå¹¶æ¥å…¥ `task_model_chain` / `download_chain` çš„ `RetryableFailure` è·¯å¾„ã€‚
- è¿›åº¦ï¼šå·²å®ŒæˆèƒŒå‹å‘é€é€»è¾‘ç³»ç»Ÿæ€§é‡æ„ï¼šæ–°å¢å…±äº«æ¨¡å— `src/engine/chain/backpressure.rs`ï¼Œç»Ÿä¸€ `task/parser/download` ä¸‰é“¾è·¯çš„ `try_send -> await send` è¡Œä¸ºä¸é”™è¯¯è¯­ä¹‰ï¼Œå¹¶é€šè¿‡ `cargo check` + `cargo test` éªŒè¯ã€‚

- ä»»åŠ¡ç›®æ ‡
   - å»ºç«‹ç»Ÿä¸€å¹¶å‘æ§åˆ¶ä¸é˜Ÿåˆ—èƒŒå‹ç­–ç•¥ï¼Œé¿å…çƒ­ç‚¹æ”¾å¤§ã€‚
- è½åœ°æ–¹æ¡ˆ
   - æ‰€æœ‰å¹¶å‘å‚æ•°é…ç½®åŒ–å¹¶æ”¯æŒåŠ¨æ€é™çº§ã€‚
   - å‘å¸ƒé˜Ÿåˆ—æ»¡æ—¶æ‰§è¡Œé˜»å¡/é™æµ/å»¶è¿Ÿé‡è¯•ç­–ç•¥ã€‚
   - æŒ‰ç§¯å‹æŒ‡æ ‡åŠ¨æ€é™ä½æ¨¡å—åˆ†å‘å¹¶å‘ã€‚
- äº¤ä»˜æ¸…å•
   - å¹¶å‘æ§åˆ¶å™¨ä¸èƒŒå‹ç­–ç•¥å®ç°ã€‚
   - ç§¯å‹ç›‘æ§ä¸å‘Šè­¦è§„åˆ™ã€‚
- éªŒæ”¶æ ‡å‡†
   - é«˜å‹ä¸‹æ— å¤§è§„æ¨¡é™é»˜ä¸¢æ¶ˆæ¯ã€‚
   - ç§¯å‹æ—¶ç³»ç»Ÿå¯è‡ªç¨³ï¼Œä¸å‡ºç°çº§è”é›ªå´©ã€‚
- æµ‹è¯•ç”¨ä¾‹
   - é«˜å¹¶å‘å‹åŠ›æµ‹è¯•ã€‚
   - é˜Ÿåˆ—æ»¡è´Ÿè½½é™çº§æµ‹è¯•ã€‚

### T11 å¯è§‚æµ‹æ€§ä¸å®¡è®¡å›ºåŒ–

- çŠ¶æ€ï¼šğŸŸ¡ è¿›è¡Œä¸­ï¼ˆæš‚ç¼“ï¼‰
- è¿›åº¦ï¼šå·²è¡¥é½èƒŒå‹ç›¸å…³å‘Šè­¦è§„åˆ™ä¸çœ‹æ¿æŸ¥è¯¢ï¼šè¦†ç›– `request_publish_backpressure_total`ã€`parser_chain_backpressure_total`ã€`download_response_backpressure_total` ä¸‰ç±»æŒ‡æ ‡åŠ `queue_closed` èšåˆå‘Šè­¦ã€‚
- è¿›åº¦ï¼šå·²è¡¥å……èƒŒå‹æ’éšœæ‰‹å†Œï¼ˆ`docs/alerts/backpressure_runbook.md`ï¼‰ï¼ŒåŒ…å« queue_full/queue_closed è¯Šæ–­ã€PromQL æ£€æŸ¥æ¸…å•ä¸å¤„ç½®è·¯å¾„ã€‚
- è¿›åº¦ï¼šå·²è¡¥å…… CAS/Fencing ä¸“é¡¹å‘Šè­¦ä¸æ’éšœæ‰‹å†Œï¼ˆ`ptm_claim_total` / `ptm_commit_total`ï¼‰ï¼Œè¦†ç›– `fencing_reject`ã€`cas_conflict`ã€`out_of_order`ã€`stale` åœºæ™¯ã€‚
- è¿›åº¦ï¼šå·²è¡¥å……é˜ˆå€¼æ ¡å‡†æ¨¡æ¿ä¸åŸºçº¿æŠ¥å‘Šæ¨¡æ¿ï¼ˆ`docs/dashboards/threshold_calibration_template.md` / `docs/dashboards/baseline_report_template.md`ï¼‰ï¼Œå¯ç›´æ¥ç”¨äºé¢„å‘å‹æµ‹åçš„é˜ˆå€¼å›ºåŒ–ã€‚

- ä»»åŠ¡ç›®æ ‡
   - å°†ç»Ÿä¸€é“¾è·¯æŒ‡æ ‡ã€æ—¥å¿—ã€äº‹ä»¶å›ºåŒ–ä¸ºä¸Šçº¿é—¨æ§›ã€‚
- è½åœ°æ–¹æ¡ˆ
   - æ¥å…¥æ–‡æ¡£çº¦å®šæŒ‡æ ‡ï¼šingressã€parserã€error_taskã€gateã€ptm_claim/commitã€‚
   - æ—¥å¿—ç»Ÿä¸€å­—æ®µï¼šrun_id/task_id/module_id/step_idx/request_id/prefix_request/decisionã€‚
   - æ›´æ–° dashboards ä¸ alertsã€‚
- äº¤ä»˜æ¸…å•
   - æŒ‡æ ‡åŸ‹ç‚¹ä»£ç ã€‚
   - ä»ªè¡¨ç›˜ä¸å‘Šè­¦é…ç½®æ›´æ–°ã€‚
   - è¿ç»´æ’éšœæ‰‹å†Œè¡¥å……ã€‚
- éªŒæ”¶æ ‡å‡†
   - å…³é”®é“¾è·¯å‡å¯æŒ‰ run_id è¿½è¸ªå…¨æµç¨‹ã€‚
   - å‘Šè­¦èƒ½è¦†ç›– CAS å†²çªã€fencing æ‹’ç»ã€ä¹±åºå †ç§¯ã€‚
- æµ‹è¯•ç”¨ä¾‹
   - æŒ‡æ ‡é‡‡é›†æ­£ç¡®æ€§æµ‹è¯•ã€‚
   - æ•…éšœæ³¨å…¥åçš„æ—¥å¿—å¯è¿½è¸ªæ€§æµ‹è¯•ã€‚

### T12 ç°åº¦åˆ‡æ¢ã€å›æ»šä¸æ—§é“¾ä¸‹çº¿

- çŠ¶æ€ï¼šğŸŸ¡ è¿›è¡Œä¸­ï¼ˆæš‚ç¼“ï¼‰
- è¿›åº¦ï¼šå·²è¡¥å……ç°åº¦å‘å¸ƒ SOP ä¸å›æ»šæ¼”ç»ƒæ¸…å•ï¼ˆ`docs/design/gray_release_sop.md` / `docs/design/rollback_drill_checklist.md`ï¼‰ï¼Œè¦†ç›–åˆ†é˜¶æ®µæ”¾é‡ã€ç§’çº§å›æ»šæµç¨‹ä¸æ¼”ç»ƒéªŒæ”¶é¡¹ã€‚

- ä»»åŠ¡ç›®æ ‡
   - åœ¨å¯å›æ»šå‰æä¸‹å®Œæˆæ–°é“¾ç°åº¦ã€ç¨³å®šåä¸‹çº¿æ—§ parser/error ä¸“é“¾ã€‚
- è½åœ°æ–¹æ¡ˆ
   - åˆ†é˜¶æ®µå¼€å…³ï¼šA å…¥å£å¹¶è¡Œã€B èŒè´£æ”¶æ•›ã€C é˜ˆå€¼æ”¶æ•›ã€D æ¸…ç†ä¸‹çº¿ã€‚
   - è®¾å®šç°åº¦æŒ‡æ ‡é˜ˆå€¼ä¸è‡ªåŠ¨å›æ»šè§¦å‘æ¡ä»¶ã€‚
   - å¤„ç†å¹¶è¡ŒæœŸé‡å¤æ¶ˆè´¹é£é™©ï¼ˆäº‹ä»¶ç‰ˆæœ¬å· + å¹‚ç­‰é”®ï¼‰ã€‚
- äº¤ä»˜æ¸…å•
   - ç°åº¦å‘å¸ƒæ–¹æ¡ˆä¸å›æ»š SOPã€‚
   - æ—§é“¾è·¯å¼€å…³ä¸æœ€ç»ˆæ¸…ç† PRã€‚
   - ä¸Šçº¿å¤ç›˜æ¨¡æ¿ã€‚
- éªŒæ”¶æ ‡å‡†
   - ç°åº¦æœŸé—´å¯ç§’çº§åˆ‡å›æ—§é“¾ã€‚
   - ç¨³å®šçª—å£å†…é”™è¯¯ç‡ã€ååã€å»¶è¿Ÿå‡è¾¾æ ‡åå®Œæˆä¸‹çº¿ã€‚
- æµ‹è¯•ç”¨ä¾‹
   - ç°åº¦æ¯”ä¾‹åˆ‡æ¢æ¼”ç»ƒã€‚
   - å›æ»šæ¼”ç»ƒä¸æ•°æ®ä¸€è‡´æ€§å›å½’ã€‚

---

## 19. å»ºè®®æ‰§è¡ŒèŠ‚å¥ï¼ˆä¸¤å‘¨ä¸€ä¸ªè¿­ä»£ï¼‰

- Iteration 1ï¼ˆåº•åº§ï¼‰
   - å®Œæˆ T01~T03ï¼Œå»ºç«‹ç»Ÿä¸€é…ç½®ã€ç»Ÿä¸€å…¥å£ä¸å†³ç­–è¯­ä¹‰ã€‚
- Iteration 2ï¼ˆæ ¸å¿ƒï¼‰
   - å®Œæˆ T04~T07ï¼Œæ‰“é€šæ¨¡å—é—­ç¯ä¸ Redis åŸå­çŠ¶æ€æœºã€‚
- Iteration 3ï¼ˆä¸€è‡´æ€§ï¼‰
   - å®Œæˆ T08~T10ï¼Œè¡¥é½å•èŠ‚ç‚¹ä¸€è‡´è¯­ä¹‰ä¸èƒŒå‹æ²»ç†ã€‚
- Iteration 4ï¼ˆä¸Šçº¿ï¼‰
   - å®Œæˆ T11~T12ï¼Œå®Œæˆå¯è§‚æµ‹å›ºåŒ–ã€ç°åº¦ã€å›æ»šä¸æ—§é“¾ä¸‹çº¿ã€‚

---

## 20. ä»»åŠ¡å¥åº·ç›˜ç‚¹ï¼ˆå½“å‰ï¼‰

> è¯´æ˜ï¼šå®Œæˆåº¦æŒ‰â€œä»£ç è½åœ° + éªŒè¯è¦†ç›– + æ–‡æ¡£æ”¶æ•›â€ç»¼åˆè¯„ä¼°ï¼Œç”¨äºæ’æœŸä¸éªŒæ”¶ä¼˜å…ˆçº§ç®¡ç†ã€‚

| ä»»åŠ¡ | å½“å‰çŠ¶æ€ | ä¼°ç®—å®Œæˆåº¦ | ä»£ç è¯æ®ï¼ˆç¤ºä¾‹ï¼‰ | ä¸»è¦å‰©ä½™é£é™© | ä¸‹ä¸€æ­¥å»ºè®® |
|---|---|---:|---|---|---|
| T01 | âœ… å·²å®Œæˆ | 100% | `src/common/model/config.rs`, `src/common/state.rs` | ä½ | ä»…ä¿æŒå›å½’ |
| T02 | âœ… å·²å®Œæˆ | 100% | `src/common/model/message.rs`, `src/engine/chain/task_model_chain.rs`, `src/engine/engine.rs` | ä½ | ä»…ä¿æŒå›å½’ |
| T03 | âœ… å·²å®Œæˆ | 100% | `src/engine/chain/task_model_chain.rs` | ä½ | ä»…ä¿æŒå›å½’ |
| T04 | âœ… å·²å®Œæˆ | 100% | `src/engine/chain/task_model_chain.rs`, `src/engine/task/module.rs`, `src/engine/task/module_processor_with_chain.rs` | ä½ | è½¬å…¥ T06 é”®æ„é€ å™¨æ”¶å£ |
| T05 | âœ… å·²å®Œæˆ | 100% | `src/engine/task/module_processor_with_chain.rs`, `src/engine/chain/task_model_chain.rs`, `src/engine/events/events.rs`, `src/engine/chain/parser_chain.rs`, `src/engine/events/event_bus.rs` | ä½ | è½¬å…¥ T06 é”®æ„é€ å™¨æ”¶å£ |
| T06 | âœ… å·²å®Œæˆ | 100% | `src/common/model/chain_key.rs`, `src/engine/task/module_processor_with_chain.rs` | ä½ | ä»…ä¿æŒå›å½’ |
| T07 | âœ… å·²å®Œæˆ | 100% | `src/lua/*.lua`, `src/engine/lua/registry.rs`, `src/cacheable/cache_service.rs` | ä½ | ä»…ä¿æŒå›å½’ |
| T08 | âœ… å·²å®Œæˆ | 100% | `src/cacheable/cache_service.rs`, `src/engine/engine.rs` | ä½ | ä»…ä¿æŒå›å½’ |
| T09 | âœ… å·²å®Œæˆ | 100% | `src/engine/chain/task_model_chain.rs`, `src/engine/events/events.rs`, `src/engine/lua/registry.rs`, `src/lua/etm_*.lua`, `scripts/ci_contract_tests.ps1`, `scripts/ci_contract_tests.sh` | ä½ | ä»…ä¿æŒå›å½’ |
| T10 | ğŸŸ¡ è¿›è¡Œä¸­ï¼ˆæš‚ç¼“ï¼‰ | 64% | `src/common/model/config.rs`, `src/engine/chain/backpressure.rs`, `src/engine/chain/task_model_chain.rs`, `src/engine/chain/parser_chain.rs`, `src/engine/chain/download_chain.rs`, `docs/configuration.md` | éå½“å‰ä¸»çº¿ï¼ŒåŠ¨æ€å¹¶å‘è°ƒèŠ‚å°šæœªè½åœ° | ä¸»çº¿å®Œæˆåå†è¿›å…¥è°ƒå‚ä¸é˜ˆå€¼å›ºåŒ– |
| T11 | ğŸŸ¡ è¿›è¡Œä¸­ï¼ˆæš‚ç¼“ï¼‰ | 91% | `src/engine/chain/backpressure.rs`, `src/engine/chain/task_model_chain.rs`, `src/engine/chain/parser_chain.rs`, `src/engine/chain/download_chain.rs`, `docs/alerts/logging_alerts.yml`, `docs/alerts/policy_alerts.yml`, `docs/dashboards/logging_dashboard.md`, `docs/alerts/backpressure_runbook.md`, `docs/alerts/cas_fencing_runbook.md`, `docs/dashboards/threshold_calibration_template.md`, `docs/dashboards/baseline_report_template.md` | éå½“å‰ä¸»çº¿ï¼Œé˜ˆå€¼æœªå®Œæˆå®æµ‹æ ¡å‡† | ä¸»çº¿å®ŒæˆåæŒ‰æ¨¡æ¿å›å¡«å¹¶å®šç‰ˆé˜ˆå€¼ |
| T12 | ğŸŸ¡ è¿›è¡Œä¸­ï¼ˆæš‚ç¼“ï¼‰ | 22% | `docs/design/gray_release_sop.md`, `docs/design/rollback_drill_checklist.md` | éå½“å‰ä¸»çº¿ï¼Œå°šæœªå®ŒæˆçœŸå®æ¼”ç»ƒ | ä¸»çº¿å®Œæˆåæ‰§è¡Œæ¼”ç»ƒå¹¶å›ºåŒ–å¼€å…³é…ç½® |

### 20.1 è¿‘æœŸä¼˜å…ˆçº§å»ºè®®ï¼ˆæŒ‰æ”¶ç›Š/é£é™©ï¼‰

1. **T10 ç»­æ¨**ï¼šä¸»çº¿ç¨³å®šåæ¢å¤å¹¶å‘ä¸èƒŒå‹åŠ¨æ€è°ƒèŠ‚èƒ½åŠ›ã€‚
2. **T11 æ”¶æ•›**ï¼šåŸºäºæœ€æ–°ä¸»çº¿å›å½’ç»“æœå›å¡«é˜ˆå€¼æ¨¡æ¿å¹¶å›ºåŒ–å‘Šè­¦é˜ˆå€¼ã€‚
