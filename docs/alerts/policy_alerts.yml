groups:
  - name: policy_decisions
    rules:
      - alert: PolicyDlqSpike
        expr: sum by (kind, event_type) (rate(policy_decisions_total{action="dlq"}[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Policy DLQ spike"
          description: "DLQ rate high for kind={{ $labels.kind }} event_type={{ $labels.event_type }}"

      - alert: PolicyRetryStorm
        expr: sum by (kind, event_type) (rate(policy_decisions_total{action="retry"}[1m])) > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Policy retry storm"
          description: "Retry rate high for kind={{ $labels.kind }} event_type={{ $labels.event_type }}"

      - alert: PolicyDropSpike
        expr: sum by (kind, event_type) (rate(policy_decisions_total{action="ack"}[5m])) > 5
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "Policy drop spike"
          description: "Ack/drop rate high for kind={{ $labels.kind }} event_type={{ $labels.event_type }}"

      - alert: PtmFencingRejectHigh
        expr: sum(rate(ptm_commit_total{result="fencing_reject"}[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PTM fencing reject high"
          description: "ptm_commit_total{result=fencing_reject} rate > 1/s for 5m"

      - alert: PtmCasConflictHigh
        expr: sum(rate(ptm_commit_total{result="cas_conflict"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PTM CAS conflict high"
          description: "ptm_commit_total{result=cas_conflict} rate > 2/s for 5m"

      - alert: PtmClaimOutOfOrderHigh
        expr: sum(rate(ptm_claim_total{result="out_of_order"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PTM out-of-order claim high"
          description: "ptm_claim_total{result=out_of_order} rate > 2/s for 5m"

      - alert: PtmClaimStaleHigh
        expr: sum(rate(ptm_claim_total{result="stale"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PTM stale claim high"
          description: "ptm_claim_total{result=stale} rate > 2/s for 5m"
